---
documentclass: article
output:
  bookdown::pdf_document2:
    toc: false
    includes:
      in_header: preamble.tex
      before_body: prefix_appendix.tex
      after_body: suffix.tex
numbersections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  fig.align='center', echo=FALSE, warning = F, message = F, out.width = '75%')
knitr::opts_knit$set(eval.after = c("fig.cap", "fig.subcap"))
```

```{r, message=F, warning=FALSE}
library(tidyverse)
library(here)

macro_data <- readRDS(here("data/tidy/comp_macro.rds"))
macro_data <- as_tibble(macro_data) %>% 
  mutate(MIP_status=recode(MIP_status, 
                           "NA"="NA",
                           "no IDR"= "No IDR",
                           "Non eligible for AMR assessment"="non eligible for AMR assessment",
                           "IDR with imbalances"="IDR with (excessive) imbalances",
                           "IDR with excessive imbalances"="IDR with (excessive) imbalances",
                           "IDR with imbalances and specific monitoring"="IDR with (excessive) imbalances"),
         SGP_edp=recode(SGP_edp, 
                        "NA"="NA",
                        "y1"= "EDP",
                        "y2"="EDP",
                        "n"="No EDP"),
         SGP_compliance=recode(SGP_compliance,
                        "compliant"="(broadly) compliant",
                        "broadly compliant"="(broadly) compliant",
                        "risk of non-compliance"="(particularly serious) risk of non-compliance",
                        "particularly serious risk of non-compliance"=
                          "(particularly serious) risk of non-compliance",
                        "particularly serious non-compliance"="(particularly serious) risk of non-compliance"),
         SGP_compliance=na_if(SGP_compliance, "no DBP submitted yet")
         ) 

area_data <- readRDS(here("data/tidy/CSR_policy_areas.rds"))
area_data <- as_tibble(area_data) %>% 
  mutate(country = as.character(country)) %>% 
  mutate(year = as.double(year))


csr_data <- full_join(macro_data, area_data,
                 by=c("iso3c"="country", "year"="year"))
```

# Main elements of the European Semester {#sec:rules}

In the following the main rules and procedures of the Semester are summarized. For an overview over the most common abbreviations used in the Semester see table \ref{tab:abbr1}.

```{=tex}
\begin{table}[b]
\centering
\caption{Abbreviations of Concepts of the European Legal Framework.}
\label{tab:abbr1}
\begin{tabular}{L{0.1\textwidth}L{0.4\textwidth}}
\toprule
\textbf{Abbreviation} & \textbf{Concept}\\
\midrule
AMR & Alert Mechanism Report \\
ASGS & Annual Sustainable Growth Strategy \\
ASG & Annual Growth Survey \\
CSR & Country-specific Recommendation \\
EDP & Excessive Deficit Procedure \\
EIP & Excessive Imbalance Procedure \\
DBP & Draft Budgetary Plan \\
IDR & In-depth Review \\
MIP & Macroeconomic Imbalances Procedure \\
MIS & Macroeconomic Imbalances Scoreboard \\
MTO & Medium-Term Budgetary Objectives \\
SGP & Stability and Growth Pact\\
\bottomrule
\end{tabular}
\end{table}
```

## A full cycle of the European Semester {#subsec:semtt}

```{=tex}
\begin{table}[b]
\centering
\caption{The main elements of a full cycle of the European Semester.}
\label{fig:timeline}
\begin{tabular}{L{0.1\textwidth}L{0.4\textwidth}}
\toprule
\textbf{Month} & \textbf{Action}\\
\midrule
November & Publication of the ASGS, the AMR and the Opinion on the DBPs by the Commission \\
December & Member States adopt budgets \\
February & Publication fo Country Report by Commission \\
April & Presentation of national reform programs and stability and convergence programs by Member States \\
May & Publication of CSRs by Commission \\
October & Publication of DBPs by Member States \\
\bottomrule
\end{tabular}
\end{table}
```

The official mandatory timetable of the European Semester runs over one year -- 
hence the name `Semester'. 
It is divided into four packages starting in November (see Figures \ref{fig:semtt} and \ref{fig:timeline}): 
the autumn, the winter, 
the spring, and the implementation package.

```{r semtt, fig.subcap=subcaps, fig.cap=fig_cap, echo=F, warning=F, out.width = '100%', out.height='75%'}
fig_cap <- paste0(
    "The main elements of the European Semester."
)
subcaps <- c('Absolute')
knitr::include_graphics(here("output/semester_tt.pdf"))
```

In November, the autumn package constitutes the start of the Semester:
the Commission publishes the *Annual Sustainable Growth Strategy* (ASGS) setting social and economic priorities as well as policy guidance for the upcoming year. At the same time, the Commission issues an Opinion on each draft budgetary plan (DPB) prepared by Euro Area Member States (see below). Also part of the European Semester are the Euro Area recommendations as well as the *Joint Employment Report*.^[The *Joint Employment Report* consist of an analysis of employment and the social situation in Europe as well as of national policy responses. The Euro Area recommendation discusses critical issues concerning the function of the Euro area and and entails suggestions for concrete measures that can be implemented on a national level.] 
The *Macroeconomic Imbalances Procedure* (MIP) is initiated by the publication of the *Alert Mechanism Report* (AMR) by the Commission. The AMR uses the *Macroeconomic Imbalances Scoreboard* (MIS, see section \ref{subsec:mip}) to assess potential (internal and/or external) economic imbalances. Those countries with imbalances that warrant further investigation are then given an in-depth review (IDR).
The winter package (February-April) comprises the publication of Country Reports 
that include the results of the IDR and are published for all Member countries in February. They comprise an analysis of the member states' current economic situation as well as their advancements made in implementing the country-specific economic policy recommendations issued during the previous cycle. Officially, Member States respond to these country reports
in the month after their publication by describing their reform strategies for 
the upcoming year, yet is discussed in the paper, informally
the content of the reports and recommendations has been agreed upon by the 
Commission and Member States already in advance.
In April, Member States present their national reform programs as well as their stability (Euro Area members) or convergence programs (non-Euro Area members). Therein, states address the policies they (intend to) implement as well as outstanding country-specific recommendations (CSR) and a three-year budget plan respectively.
The spring package (May-July) consists of the assesment of these programs by the Commission
as well as the publication and endorsement 
of country-specific recommendations (CSRs). 
The recommendations are integrated into next year's national budgets and reform 
plans of Member States. CSRs constitute individually customized
advice for member states "on how to boost jobs, growth and investment, while 
maintaining sound public finances" \citep{EuropeanCommission:EuropeanSemester}.
They specifically take into account the priorities identified in the Annual Sustainable
Growth Strategy and are endorsed by the Council in July. 
The Semester closes with the implementation package (August till October), in 
which Member States incorporate the CSR into reform plans and national budgets 
for the following year. Euro Area members additionally need to publish a DBP in October that subsequently is assessed by the Commission with relevant CSRs and Stability and Growth requirements in mind (Commission Opinion on DBPs). It assesses the plans as either compliant, broadly compliant or at risk of non-compliance. The Commissions Opinion can then be taken into account when finalizing national budgets. This constitutes a whole cycle. Whenever a member state is part of a different financial assistance program supervised by the European Union (e.g. the *European Stability Mechanism* for Greece, or the *Balance of payments assistance facility* for Hungary), it does not partake in the European Semester. In the following, the two main elements of the semester, the MIP and the SGP, are explained in more detail.


## The Macroeconomic Imbalances Procedure {#subsec:mip}

As part of the European Semester the MIP was introduced in 2011 as a consequence of the \`\`Six Pack" reform of economic governance. It consists of a scoreboard -- the Macroeconomic Imbalances Scoreboard (MIS) -- that contains 14 headline and 28 auxiliary indicators meant to quantify external and internal (im)balances, as well as the overall competitiveness of the member state in question. The headline indicators are summarized in table \ref{tab:headlineInd}. Headline indicators (3) - (5) are explicitly labeled as measuring 'competitiveness' \citep[]{EuropeanCommission:StaffMIP} and thereby contain
information on how the Commission interprets this malleable concept in practice (see below).

```{=tex}
\begin{table}
\centering
\caption{The headline indicators of the MIS. Indicators (3) - (5) are meant to measure 'competitiveness'.}
\label{tab:headlineInd}
\begin{tabular}{c L{0.4\textwidth}L{0.4\textwidth}}
\toprule
\textbf{\#} & \textbf{Indicator} & \textbf{Unit}\\
\midrule
(1) & Current account balance & 3 year average \\
(2) & Net international investment position (NIIP) & per cent of GDP \\
(3) & Real effective exchange rate (REER) & 3 year percentage change\\
(4) & Global export market shares & 5 year percentage change \\
(5) & Unit labor costs (ULC) & 3 year percentage change\\
(6) & House price index & 1 year percentage change\\
(7) & Private sector credit flows (transactions) & per cent of GDP\\
(8) & Private sector credit debt & per cent of GDP\\
(9) & General government sector debt & per cent of GDP\\
(10) & Unemployment rate & 3 year average\\
(11) & Youth unemployment rate & 3 year change in p.p.\\
(12) & Long-term unemployment rate & 3 year change in p.p.e\\
(13) & Activity rate & 3 year change in p.p.\\
(14) & Financial sector liabilitiest & 1 year percentage change\\
\bottomrule
\end{tabular}
\end{table}
```

For each headline indicator indicative thresholds are assigned.^[
  The thresholds represent the lower and upper quartiles of the
  distribution of the indicators' values for the Member States in a
  pre-defined time period. The (indicator-specific) dates can be found in
  \citet[][p. 5-6]{EuropeanCommission:StaffMIP}.
]
The breach of one or more thresholds necessitates an economic investigation undertaken by the Commission as part of the AMR. The AMR assesses whether Member States are at risk of imbalances or exhibit imbalances and identifies those countries that need further investigation via an IDR. The IDRs then form part of the basis for MIP-specific CSRs.

An IDR may result in one of the following assessments: (1) *no imbalances*, (2) *imbalances*, (3) *excessive imbalances* or (4) *excessive imbalances with corrective action*. Thus, the MIP consist of a preventive arm and a corrective arm. The corrective arm comprises the excessive imbalance procedure (EIP), a procedure that can be activated for Member States with excessive imbalances. As part of the EIP, a corrective action plan is submitted that envisages measures as well as a time frame. While Member States that fail to comply with the corrective action plan may in principle face sanctions, such as fines, so far no Member State has been subject to an EIP. In cases where there are (excessive) imbalances, specific monitoring is applied.^[Prior to 2016 only selected Euro Area countries identified with imbalances relevant to the Euro Area and countries exhibiting excessive imbalances received specific monitoring.] In practice, this takes the form of intensified dialogue between national authorities and the European Commission. This dialogue is meant to ensure that the Member States implement policy measures according to their recommendations issued by the Commission.

## The Stability and Growth Pact {#subsec:sgp}

Surveillance under the SGP distinguishes between Euro Area and non-Euro Area members. The SGP was adopted in 1997 to complement the restricted role of the ECB. Since 2013 the "Two Pack" regulation ensures closer monitoring as well as policy coordination for Euro Area members in order to counteract tendencies that might culminate in another financial crisis. The central provisions are that (1) government deficits must not exceed 3% of GDP, that (2) total government debt must not exceed 60% of GDP, and (3) that the structural deficit does not exceed a country specific value. The "Two Pack" regulation envisages the assessment of draft budgetary plans (DPBs) that have to be submitted by Member States in October each year as well as the "correction of excessive deficit" \citep{TwoPack}. Central for the evaluation of the DBP are the adherence to CSRs as well as EDP recommendations. The evaluation of DBPs should provide concrete ex ante guidance and categorizes the countries as either (1) compliant, (2) broadly compliant, or (3) at risk of non-compliance.

Just as the MIP, the SGP comprises a preventive and a corrective arm. The *preventive arm* is meant to monitor budgetary policies. It does so via the Medium-Term Budgetary Objectives (MTOs) that specify budgetary targets for each Member State and takes into account cyclical constraints and should make sure that budgets are in line with SGP demands \citep[for a thorough discussion of MTOs and a critique see][]{HeimbergerKapeller:2017pot}. The CSRs also include references to the preventive arm of the SGP: here, a *Significant Deviations Procedure* might be opened if Member States do not adhere to their MTOs. If they fail to correct their budget, they might become subject to the corrective arm of the SGP, the *Excessive Deficit Procedure* (EDP).
Member States' ideas on how to reach their MTOs are the subject of the *stability and convergence programs*. Those programs are in turn assessed by the Commission performing a structural balance analysis as well as keeping in mind the expenditure benchmark, a rule that seeks to keep the net growth rate of government spending at par with its medium-term potential economic growth rate.
As indicated above, the corrective arm of the SGP consists of the EDP. EDPs are conducted since 2009 and are meant to ensure a correction of excessive deficits or debts. They usually start with a Member State being at risk of breaching the 3% deficit threshold or the 60% debt level. Member States have a specific time horizon (usually 6 months) in order to comply with Commission recommendations issued at the beginning of an EDP. Since 2013 the "Two Pack" creates a system of closer monitoring and reporting on countries.

If Member States fail to implement effective action as described by the recommendations, the EDP is stepped up, a new deadline is set and revised recommendations are issued. Such step ups usually come with sanctions. Such a choice is decided by the Commission as well as the Council. If, however, effective action was taken, the EDP is abrogated. This means that Member States can either be in or out of an EDP. For Euro Area members an entry into an EDP means also to draft "economic partnership programs" (EPPs), which provide a roadmap for structural reforms considered as instrumental to an effective and lasting correction of the excessive deficit" \citep{EuropeanCommission:EDP}.

# The indicators of the Semester in practice {#sec:descriptives}

To complement the existing literature on the European Semester, and to 
illustrate more clearly what the rules and institutions mentioned in Section 
\ref{sec:rules} mean in practice, 
this section comprises a description of how EU Member States are actually 
classified by the legally binding indicators of the Semester.
These classifications take place within the SGP and MIP procedure. 
In the course of the MIP Member States are evaluated according to the MIS. The 
first step of the evaluation consists in detecting benchmark breaches of the 14
headline indicators of the MIS. If Member States are trespassing, the Commission
commands an in-depth review (IDR). Countries in need of an IDR are declared in the
Alert Mechanism Report. The IDR consists in visits to Member States, closer monitoring 
and as the name indicates a closer inspection of alleged imbalances. The outcome 
of the IDR can either be that no imbalances, imbalances or excessive imbalances
where detected. The categorization that we use for the MIP are the results of the 
IDRs, meaning that countries are allocated into one of the following categories: 
(1) no IDR, (2) IDR with no imbalances, (3) IDR with (excessive)  imbalances, and 
(4) non eligible for AMR assessment. For the sake of clarity, the categories 
'IDR with imbalances', 'IDR with excessive imbalances' and 'IDR with imbalances 
and specific monitoring (before 2016)' were merged into one category ('IDR with 
(excessive) imbalances') since all of the categories send a somewhat similar signal 
to Member States. Thus, in practice there are five (six) different categories, 
and not just three.

In the context of the SGP two classifications prevail. First, we consider the 
evaluation of draft budgetary plans of Euro Area members by the Commission. 
The drafts are published in October and then classified by the Commission to either
comply, broadly comply, be at risk of non-compliance or to be at a particularly 
serious risk of non-compliance with SGP provisions. 
Second, we use the presence or absence of an Excessive Deficit Procedure (EDP) as
a categorization^[The assessment of compliance with SGP rules via medium-term budgetary objectives 
(MTOs) and the launch or abrogation of an Excessive Deficit Procedure (EDP) is 
partly independent of the Semesters timetable and depends on the budgetary situation 
of Member States.]. Thus, Euro Area Member States are categorized as either
*(broadly) compliant* or *(particularly serious) risk of non-compliance*, and
*all* Member States along their status in an EDP (yes or no).


## MIP and SGP Status Over Time

```{r, echo=F}
MIP_count_rel <- macro_data %>%
  filter(year<2020, year>=2012) %>% 
  select(any_of(c("year", "MIP_status"))) %>%
  count(MIP_status, year, .drop = FALSE) %>% 
  filter(!is.na(MIP_status), !is.na(year)) %>%
  group_by(year) %>% 
  mutate(year_total=sum(n)) %>% 
  ungroup() %>% 
  mutate(year_rel = n /year_total) %>%
  select(any_of(c("year", "MIP_status", "year_rel"))) %>%
  pivot_wider(names_from = "year", values_from = "year_rel") %>%
  pivot_longer(
    cols = -any_of(c("MIP_status")), 
    names_to = "year", values_to = "year_rel") %>%
  mutate(year_rel=ifelse(is.na(year_rel), 0, year_rel), year=as.double(year)) %>%
  mutate(
    MIP_status=ifelse(
      MIP_status=="IDR with no imbalances", "IDR (w/o imb.)", ifelse(
        MIP_status=="IDR with (excessive) imbalances", "IDR (w/ imb.)", ifelse(
          MIP_status=="non eligible for AMR assessment", "Not eligible", 
          as.character(MIP_status)
        )
      )),
    MIP_status=ordered(
      MIP_status, 
      levels=c(
        "No IDR", "IDR (w/o imb.)",
        "IDR (w/ imb.)", "Not eligible")
      )
    ) %>% 
  ggplot(data = ., mapping = aes(x=year, y=year_rel, fill=MIP_status)) +
  geom_area() + 
  labs(title = "MIP status") +
  scale_x_continuous(
    breaks = seq(2012, 2020, 2),
    expand = expansion()
  ) +
  scale_y_continuous(
    limits = c(0, 1), expand = expansion(), 
    breaks = seq(0,1,0.2),
    labels = scales::percent_format()
  ) +
  scale_fill_viridis_d() +
  guides(fill=guide_legend(nrow=2)) +
  theme_bw() +
  theme(
    legend.position = "bottom", legend.title = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(), panel.border = element_blank()
  )
```

```{r, echo=F}
SGP_count_rel <- macro_data %>%
  filter(year<2020, year>=2009) %>% 
  select(any_of(c("year", "SGP_edp"))) %>%
  count(SGP_edp, year, .drop = FALSE) %>% 
  filter(!is.na(SGP_edp), !is.na(year)) %>%
  group_by(year) %>% 
  mutate(year_total=sum(n)) %>% 
  ungroup() %>% 
  mutate(year_rel = n /year_total) %>%
  select(any_of(c("year", "SGP_edp", "year_rel"))) %>%
  pivot_wider(names_from = "year", values_from = "year_rel") %>%
  pivot_longer(
    cols = -any_of(c("SGP_edp")), 
    names_to = "year", values_to = "year_rel") %>%
  mutate(year_rel=ifelse(is.na(year_rel), 0, year_rel), year=as.double(year)) %>%
  mutate(SGP_edp=ordered(SGP_edp, levels=c("No EDP", "EDP"))) %>% 
  ggplot(data = ., mapping = aes(x=year, y=year_rel, fill=SGP_edp)) +
  geom_area() + 
  labs(title = "SGP status") +
  scale_x_continuous(
    breaks = seq(2009, 2020, 2),
    expand = expansion()
  ) +
  scale_y_continuous(
    limits = c(0, 1), expand = expansion(), 
    breaks = seq(0,1,0.2),
    labels = scales::percent_format()
  ) +
  scale_fill_viridis_d() +
  guides(fill=guide_legend(nrow=2)) +
  theme_bw() +
  theme(
    legend.position = "bottom", legend.title = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(), panel.border = element_blank()
  )
```

```{r, echo=F}
SGP_count_rel_comp <- macro_data %>%
  filter(year<2020, year>=2014) %>%   
  select(any_of(c("year", "SGP_compliance"))) %>%
  count(SGP_compliance, year, .drop = FALSE) %>% 
  filter(!is.na(SGP_compliance), !is.na(year)) %>%
  group_by(year) %>% 
  mutate(year_total=sum(n)) %>% 
  ungroup() %>% 
  mutate(year_rel = n /year_total) %>%
  select(any_of(c("year", "SGP_compliance", "year_rel"))) %>%
  pivot_wider(names_from = "year", values_from = "year_rel") %>%
  pivot_longer(
    cols = -any_of(c("SGP_compliance")), 
    names_to = "year", values_to = "year_rel") %>%
  mutate(year_rel=ifelse(is.na(year_rel), 0, year_rel), year=as.double(year)) %>%
  mutate(
    SGP_compliance = ifelse(
      SGP_compliance=="(particularly serious) risk of non-compliance",
      "risk of non-compliance", as.character(SGP_compliance)),
    SGP_compliance=ordered(
      SGP_compliance, 
      levels=c(
        "(broadly) compliant", 
        "risk of non-compliance")
      )
    ) %>% 
  ggplot(data = ., mapping = aes(x=year, y=year_rel, fill=SGP_compliance)) +
  geom_area() + 
  labs(title = "Compliance with SGP rules") +
  scale_x_continuous(
    breaks = seq(2012, 2020, 2),
    expand = expansion()
  ) +
  scale_y_continuous(
    limits = c(0, 1), expand = expansion(), 
    breaks = seq(0,1,0.2),
    labels = scales::percent_format()
  ) +
  scale_fill_viridis_d() +
  guides(fill=guide_legend(nrow = 2)) +
  theme_bw() +
  theme(
    legend.position = "bottom", legend.title = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(), panel.border = element_blank()
  )
```

```{r, echo=F}
sgp_mip_fig <- ggpubr::ggarrange(
  MIP_count_rel, SGP_count_rel, SGP_count_rel_comp, 
  ncol = 3, labels = paste0(letters[1:3], ")"))

ggsave(
  filename = here("markdown/figures/sgp_mip_dynamics.pdf"), 
  plot = sgp_mip_fig, width = 9, height = 4)
```

```{r SGPMIP, fig.subcap=subcaps, fig.cap=fig_cap, echo=F, warning=F, out.width = '100%', out.height = '75%'}
fig_cap <- paste0(
    "MIP and SGP status over time (panels a and b), ",
    "as well compliance to SGP rules (panel c). ",
    "The category 'risk of non-compliance' in panel c also includes category ",
    "particularly serious risk of non-compliance."
)
subcaps <- c('Absolute')
knitr::include_graphics(
  here("markdown/figures/sgp_mip_dynamics.pdf"))
```

How are countries classified according to the MIP and SGP procedures described 
in section \ref{sec:rules} in practice? Figure \ref{fig:SGPMIP} shows the 
relative number of countries that belong to an MIP (a) and SGP (b) status over 
time, and how countries comply with the SGP rules (c). Regarding the MIP status, 
the overall numbers remain relatively stable, with those countries not being 
eligible for AMR assessment and those that are not diagnosed with imbalances 
after receiving and IDR being rather temporal exceptions, and those not 
receiving an IDR at all slightly growing over time. When it comes to the SGP 
(figure \ref{fig:SGPMIP}b), one immediately notices that the share of countries 
participating in an EDP decreases drastically over time, from 100% to almost 
0% of Member States. The initially high shares are due to the fact that the EDP 
was introduced after the financial and economic crisis
, a time where practically all Member States experienced 
difficulties with their budgets and government debts. The current state with 
almost no countries in an EPD is as it should be under normal conditions. 
With regard to the compliance (figure \ref{fig:SGPMIP}c), a slight majority 
of countries is consistently classified as (broadly) compliant, with the 
numbers being relatively stable.

```{r}
mip_sgp_data_raw <- macro_data %>%
  filter(!is.na(MIP_status), !is.na(SGP_compliance)) %>%
  mutate(
    SGP_compliance = ifelse(
      SGP_compliance=="(particularly serious) risk of non-compliance",
      "risk of non-compl.", as.character(SGP_compliance)),
    SGP_compliance=ordered(
      SGP_compliance, 
      levels=c(
        "(broadly) compliant", 
        "risk of non-compl.")
      )
    ) %>% 
  mutate(
    MIP_status=ifelse(
      MIP_status=="IDR with no imbalances", "IDR (w/o imb.)", ifelse(
        MIP_status=="IDR with (excessive) imbalances", "IDR (w/ imb.)", ifelse(
          MIP_status=="non eligible for AMR assessment", "Not eligible", 
          as.character(MIP_status)
        )
      )),
    MIP_status=ordered(
      MIP_status, 
      levels=c(
        "No IDR", "IDR (w/o imb.)",
        "IDR (w/ imb.)", "Not eligible")
      )
    ) 

mip_sgp_comp_data <- mip_sgp_data_raw %>% 
  count(MIP_status, SGP_compliance) %>%
  group_by(MIP_status) %>%
  mutate(SGP_compliance_total=sum(n)) %>%
  mutate(SGP_compliance_rel = n /SGP_compliance_total) 

sgpp_sgp_comp_data <- mip_sgp_data_raw %>% 
  count(SGP_edp, SGP_compliance) %>%
  group_by(SGP_edp) %>%
  mutate(SGP_compliance_total=sum(n)) %>%
  mutate(SGP_compliance_rel = n /SGP_compliance_total) 

mip_sgp_status_data <- mip_sgp_data_raw %>% 
  select(year, iso3c, MIP_status, SGP_edp) %>%
  count(MIP_status, SGP_edp) %>%
  group_by(MIP_status) %>%
  mutate(SGP_edp_total=sum(n)) %>%
  mutate(SGP_edp_rel = n /SGP_edp_total) 
```

```{r}
update_barplot <- function(x){
  x + 
    scale_fill_viridis_d() +
    scale_y_continuous(expand = expansion(), 
                       labels = scales::percent_format(scale = 100)) +
    theme_bw() +
    theme(
      panel.border = element_blank(),
      axis.ticks = element_blank(),
      axis.line = element_line(),
      axis.text.x = element_text(angle = 0, vjust = 1, hjust = 0.5), 
      legend.position = "bottom",
      legend.title = element_blank(),
      legend.text = element_text(size = 13),
      plot.title = element_text(hjust = 0.5, size=14)
    )
}
mip_sgp_comp_bar_plot <- ggplot(
  data = mip_sgp_comp_data, 
  mapping = aes(
    x=MIP_status, 
    fill=SGP_compliance, 
    y=SGP_compliance_rel)
  ) +
  geom_bar(stat = "identity") +
  labs(
    title = "MIP status and SGP compliance"
  )
mip_sgp_comp_bar_plot <- update_barplot(mip_sgp_comp_bar_plot)

mip_sgp_edp_bar_plot <- ggplot(
  data = mip_sgp_status_data, 
  mapping = aes(
    x=MIP_status, 
    fill=SGP_edp, 
    y=SGP_edp_rel)
  ) +
  geom_bar(stat = "identity") +
  labs(
    title = "MIP and SGP status"
  )
mip_sgp_edp_bar_plot <- update_barplot(mip_sgp_edp_bar_plot)

sgp_edp_compl_bar_plot <- ggplot(
  data = sgpp_sgp_comp_data, 
  mapping = aes(
    x=SGP_edp, 
    fill=SGP_compliance, 
    y=SGP_compliance_rel)
  ) +
  geom_bar(stat = "identity") +
  labs(
    title = "SGP compliance and SGP status"
  )
sgp_edp_compl_bar_plot <- update_barplot(sgp_edp_compl_bar_plot)
```

```{r, echo=F}
sgp_mip_cor_fig <- ggpubr::ggarrange(
  mip_sgp_comp_bar_plot, mip_sgp_edp_bar_plot, sgp_edp_compl_bar_plot,
  ncol = 3, labels = paste0(letters[1:3], ")"))

sgp_mip_cor_fig <- ggpubr::annotate_figure(
  sgp_mip_cor_fig, 
  top = ggpubr::text_grob(
    "MIP status, SGP status, and SGP compliance (2014-2019)", 
    size = 16))

ggsave(
  filename = here("markdown/figures/sgp_mip_correlation.pdf"), 
  plot = sgp_mip_cor_fig, width = 13, height = 4)
```

How do the MIP and SGP status correlate with each other? Are those countries 
receiving an IDR also participating in an EDP? And are countries that comply 
with the SGP rules less likely to receive an IDR? In Figure \ref{fig:SGPMIPCOR} 
one can observe how the MIP status correlates to the compliance with the SGP 
rules (panel a) and the SGP status (panel b). The figure contains all 
observations between 2014 and 2019 and confirms what one might have expected: 
countries that do not receive an IDR in the MIP tend to be more compliant with 
the SGP rules, and are less often subject to an EDP. Interestingly, however, 
countries receiving an IDR but are not diagnosed with imbalances are relatively 
more likely to run a risk of non-compliance with the SGP rules than being 
subject to an EDP. As with regard to the other status groups, only minor 
differences are observable. Finally, as shown in panel c, those countries that 
do not undergo an EDP tend to be considered more compliant with the SGP rules 
than the rest.

```{r SGPMIPCOR, fig.subcap=subcaps, fig.cap=fig_cap, echo=F, warning=F, out.width = '100%', out.height='75%'}
fig_cap <- paste0(
    "Relationship between MIP status and SGP status (panel a) ",
    "and MIP status and SGP compliance (panels b). "
)
subcaps <- c('Absolute')
knitr::include_graphics(
  here("markdown/figures/sgp_mip_correlation.pdf"))
```

## The persistence of MIP and SGP status classifications

```{r, echo=F}
contingency_data_mip <- macro_data %>%
  select(
    contains("status"), contains("sgp"), contains("mip"),
    any_of(c("country_group_jee", "year", "iso3c"))
    ) %>%   
  dplyr::filter(!is.na(MIP_status)) %>%
  mutate(
    MIP_status=ifelse(
      MIP_status=="IDR with no imbalances", "IDR (w/o imb.)", ifelse(
        MIP_status=="IDR with (excessive) imbalances", "IDR (w/ imb.)", ifelse(
          MIP_status=="non eligible for AMR assessment", "Not eligible", 
          as.character(MIP_status)
        )
      )),
    MIP_status=ordered(
      MIP_status, 
      levels=c(
        "No IDR", "IDR (w/o imb.)",
        "IDR (w/ imb.)", "Not eligible")
      )
    )
  
```

```{r, eval=F}
 %>%
  mutate(
    SGP_compliance = ifelse(
      SGP_compliance=="(particularly serious) risk of non-compliance",
      "risk of non-compliance", as.character(SGP_compliance)),
    SGP_compliance=ordered(
      SGP_compliance, 
      levels=c(
        "(broadly) compliant", 
        "risk of non-compliance")
      )
    ) 
```

```{r, echo=F}
years <- 2012:2018

MIP_contingency <- contingency_data_mip %>%
  select(one_of("iso3c", "year", "MIP_status")) %>%
  dplyr::filter(year<2020) %>% 
  pivot_wider(id_cols = "iso3c", 
              names_from = "year", values_from = "MIP_status")

results <- list()
for (y in years){
  con_table <- table(
    MIP_contingency[[as.character(y)]], 
    MIP_contingency[[as.character(y+1)]])
  results[[as.character(y)]] <- con_table
}
abs_results <- apply(simplify2array(results), 1:2, sum, na.rm=T)

results <- list()
for (y in years){
  con_table <- prop.table(
    table(MIP_contingency[[as.character(y)]], 
          MIP_contingency[[as.character(y+1)]]), 
    margin = 1)
  results[[as.character(y)]] <- con_table
}
cond_results <- apply(simplify2array(results), 1:2, mean, na.rm=T)
```

```{r}

mip_abs_results_min_max <- simplify2array(
  table(
    MIP_contingency[[as.character(min(years))]], 
    MIP_contingency[[as.character(max(years)+1)]]
    )
  )

mip_rel_results_min_max <- simplify2array(
  prop.table(
    table(
      MIP_contingency[[as.character(min(years))]], 
      MIP_contingency[[as.character(max(years)+1)]]), 
    margin = 1)
  )
```

```{r, echo=F}
mip_abs_changes <- abs_results %>%
  as.data.frame() %>%
  rownames_to_column(var = "Status in t-1") %>%
  pivot_longer(cols = -one_of("Status in t-1"), 
               names_to = "Status in t", 
               values_to = "Frequency") %>%
  ggplot(data = .,
       aes(x=!!as.name("Status in t-1"), 
           y=!!as.name("Status in t"), 
           fill=Frequency)
       ) + 
  geom_tile() +
  geom_text(aes(label = round(Frequency, 2)), color = "white", size = 5) +
  labs(title = "Absolute changes in status") + 
  scale_fill_viridis_c(option = "D", end = 0.9) +
  theme_bw() + 
  theme(
    plot.title = element_text(hjust = 0.5, size = 14),
    axis.ticks = element_blank(), 
    panel.margin = unit(-0.8, "lines"),
    axis.title = element_text(size=13),
    axis.text = element_text(hjust = 1, size=12),
    axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 1),
    panel.border = element_blank())

mip_prob_changes <- cond_results %>%
  as.data.frame() %>%
  rownames_to_column(var = "Status in t-1") %>%
  pivot_longer(cols = -one_of("Status in t-1"), 
               names_to = "Status in t", 
               values_to = "Probability") %>%
  mutate(Probability = 100*Probability) %>%
  ggplot(aes(x=!!as.name("Status in t-1"), 
             y=!!as.name("Status in t"), 
             fill=Probability)) + 
  geom_tile() +
  geom_text(
    aes(label = scales::percent(round(Probability, 2), scale = 1)), 
    color = "white", size = 5) +
  labs(title = "Conditional probabilities") + 
  scale_fill_viridis_c(option = "D", end = 0.9) +
  theme_bw() + 
  theme(
    plot.title = element_text(hjust = 0.5, size=14),
    axis.ticks = element_blank(), 
    panel.margin = unit(-0.8, "lines"),
    axis.title = element_text(size=13),
    axis.text = element_text(hjust = 1, size=12),
    axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 1),
    panel.border = element_blank())
```

```{r}
mip_changes <- ggpubr::ggarrange(
  mip_abs_changes, mip_prob_changes,
  ncol = 2, labels = paste0(letters[1:2], ")")
  )
  
mip_changes <- ggpubr::annotate_figure(
  mip_changes, 
  top = ggpubr::text_grob(
    "Absolute and conditional changes for MIP status (2014-2019)", 
    size = 16))

mip_changes_file <- here("markdown/figures/mip_changes.pdf")

ggsave(
  filename = mip_changes_file, 
  plot = mip_changes, width = 14, height = 4)
```

The literature on comparative economic development in Europe has diagnosed the 
relevance of path dependencies for the development trajectories of the Member 
States in the EU 
\citep[e.g.][and the literature review]{Kapeller:2019cds, Graebner.2020u}. 
This begs the question of whether this path dependency is also visible in the 
MIP and SGP status of the countries. To this end, one may consider the status 
of a country in time $t-1$ and $t$ to see how often countries actually change 
their status, and conditional probabilities for a status change to identify 
potential path dependencies.^[One might argue that the observational period
is too short and that the mechanisms determining the classification of the
countries only take effect over longer time periods. An alternative 
graphical illustration comparing the classification changes over the whole
period can be found down below. 
This figure indicates that changes do
take place over the whole period and that the mechanism is thus effective. ]

```{r mipTransfersold, fig.subcap=subcaps, fig.cap=fig_cap, echo=F, warning=F, out.width='100%', eval=FALSE}
fig_cap <- paste0(
  "Number of absolute changes between MIP status (panel a) and conditional ",
  "probability for the status in $t$ given the status in $t-1$ (panel b). ",
  "The underlying data refers to all years between 2012 and 2019."
)

knitr::include_graphics(mip_changes_file)
```

Panels a and b in Figure \ref{fig:mipTransfers} present the results for the MIP status in the 
time period between 2012 and 2019. Panel a) represents absolute changes and 
indicates that most 'movements' take place within the group of 
'IDR with imbalances' and 'No IDR'. 
If one considers the conditional changes in status (panel b), which shows the 
probability to be in status $y$ when the status in the previous year was $x$,
it becomes even clearer that countries not receiving an IDR come into a 
situation where they become subject of the IDR only in 1 out of 10 cases. 
Countries for which no imbalances were found in $t-1$ have always moved into 
the group
of not receiving an IDR in $t$. Conversely, countries in an 'unfavorable status', 
i.e. IDR with imbalances or being not eligible at all most likely remain in 
this situation in the future. At least for the limited time horizon for which 
the Semester exists, it remains very unlikely that a country diagnosed with 
imbalances in the past manages to get rid of them in the future. Thus, the 
overall path dependency of European development trajectories diagnosed in the 
macroeconomic and political economy literature is clearly visible in the MIP 
assessments as well: There is a tendency for countries to remain in either a 
problematic or non-problematic area, but changes between the two groups are 
scarce.^[Note that this does not imply any causal statement about the effect
of the classification. All that means is that the developmental path-dependence
diagnosed in the polarization literature also shows itself in the classification
of the countries within the semester.]
A consideration not of yearly changes, but changes in classification between 
the 2012 and 2019 corroborates this impression (see down below for a
detailed exposition):
countries tend to remain in the good or bad status they begin with, and all 
positive exceptions are realized by countries on favorable development paths
(core and catch-up countries, see below).
The assessment of the countries' compliance with the SGP rules indicates a 
similar pattern: compliance behavior is rather persistent (see panels c and d), 
yet it is relatively more likely that countries become more compliant rather 
than the other way around.

```{r, echo=F}
contingency_data_sgp <- macro_data %>%
  select(
    contains("status"), contains("sgp"), contains("mip"),
    any_of(c("country_group_jee", "year", "iso3c"))
    ) %>%   
  dplyr::filter(!is.na(SGP_edp)) %>%
  mutate(
    SGP_compliance = ifelse(
      SGP_compliance=="(particularly serious) risk of non-compliance",
      "risk of non-compliance", as.character(SGP_compliance)),
    SGP_compliance=ordered(
      SGP_compliance, 
      levels=c(
        "(broadly) compliant", 
        "risk of non-compliance")
      )
    ) 
  
SGP_contingency <- contingency_data_sgp %>%
  select(one_of("iso3c", "year", "SGP_edp")) %>%
  mutate(SGP_edp=factor(SGP_edp)) %>% 
  pivot_wider(id_cols = "iso3c", 
              names_from = "year", values_from = "SGP_edp")

years <- 2009:2018
results <- list()
for (y in years){
  con_table <- table(
    SGP_contingency[[as.character(y)]], 
    SGP_contingency[[as.character(y+1)]])
  results[[as.character(y)]] <- con_table
}
abs_results <- apply(simplify2array(results), 1:2, sum, na.rm=T)

results <- list()
for (y in years){
  con_table <- prop.table(
    table(SGP_contingency[[as.character(y)]], 
          SGP_contingency[[as.character(y+1)]]), 
    margin = 1)
  results[[as.character(y)]] <- con_table
}
cond_results <- apply(simplify2array(results), 1:2, mean, na.rm=T)
```

```{r}

edp_abs_results_min_max <- simplify2array(
  table(
    SGP_contingency[[as.character(min(years))]], 
    SGP_contingency[[as.character(max(years)+1)]]
    )
  )

edp_rel_results_min_max <- simplify2array(
  prop.table(
    table(
      SGP_contingency[[as.character(min(years))]], 
      SGP_contingency[[as.character(max(years)+1)]]), 
    margin = 1)
  )
```


```{r, echo=F}
sgp_abs_changes <- abs_results %>%
  as.data.frame() %>%
  rownames_to_column(var = "Status in t-1") %>%
  pivot_longer(cols = -one_of("Status in t-1"), 
               names_to = "Status in t", 
               values_to = "Frequency") %>%
  ggplot(data = .,
       aes(x=!!as.name("Status in t-1"), 
           y=!!as.name("Status in t"), 
           fill=Frequency)
       ) + 
  geom_tile() +
  geom_text(aes(label = round(Frequency, 2)), color = "white", size = 5) +
  labs(title = "Participation in EDP:\nAbsolute changes") + 
  scale_fill_viridis_c(option = "D", end = 0.9) +
  theme_bw() + 
  theme(
    axis.ticks = element_blank(), 
    plot.title = element_text(hjust = 0.5),
    axis.text = element_text(size = 12),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    panel.border = element_blank())

sgp_cond_changes <- cond_results %>%
  as.data.frame() %>%
  rownames_to_column(var = "Status in t-1") %>%
  pivot_longer(cols = -one_of("Status in t-1"), 
               names_to = "Status in t", 
               values_to = "Probability") %>%
  mutate(Probability = 100*Probability) %>%
  ggplot(aes(x=!!as.name("Status in t-1"), 
             y=!!as.name("Status in t"), 
             fill=Probability)) + 
  geom_tile() +
  geom_text(
    aes(label = scales::percent(round(Probability, 2), scale = 1)), 
    color = "white", size = 5) +
  labs(title = "Participation in EDP\nConditional changes") + 
  scale_fill_viridis_c(option = "D", end = 0.9) +
  theme_bw() + 
  theme(
    axis.ticks = element_blank(), 
    plot.title = element_text(hjust = 0.5),
    axis.text = element_text(size = 12),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    panel.border = element_blank())
```

```{r}
contingency_data_sgp_comp <- contingency_data_sgp %>%
  dplyr::filter(!is.na(SGP_compliance))

SGP_contingency <- contingency_data_sgp_comp %>%
  select(one_of("iso3c", "year", "SGP_compliance")) %>%
  mutate(SGP_compliance=factor(SGP_compliance)) %>% 
  pivot_wider(id_cols = "iso3c", 
              names_from = "year", values_from = "SGP_compliance")

years <- 2014:2018
results <- list()
for (y in years){
  con_table <- table(
    SGP_contingency[[as.character(y)]], 
    SGP_contingency[[as.character(y+1)]])
  results[[as.character(y)]] <- con_table
}
abs_results <- apply(simplify2array(results), 1:2, sum, na.rm=T)

results <- list()
for (y in years){
  con_table <- prop.table(
    table(SGP_contingency[[as.character(y)]], 
          SGP_contingency[[as.character(y+1)]]), 
    margin = 1)
  results[[as.character(y)]] <- con_table
}
cond_results <- apply(simplify2array(results), 1:2, mean, na.rm=T)
```

```{r}

sgp_abs_results_min_max <- simplify2array(
  table(
    SGP_contingency[[as.character(min(years))]], 
    SGP_contingency[[as.character(max(years)+1)]]
    )
  )

sgp_rel_results_min_max <- simplify2array(
  prop.table(
    table(
      SGP_contingency[[as.character(min(years))]], 
      SGP_contingency[[as.character(max(years)+1)]]), 
    margin = 1)
  )

save(
  file = here::here("output/min_max_tansitions.Rdata"),
  list = c("mip_abs_results_min_max", "mip_rel_results_min_max",
           "sgp_abs_results_min_max", "sgp_rel_results_min_max",
           "edp_abs_results_min_max", "edp_rel_results_min_max",
           "MIP_contingency"))
```


```{r, echo=F}
sgp_comp_abs_changes <- abs_results %>%
  as.data.frame() %>%
  rownames_to_column(var = "Status in t-1") %>%
  pivot_longer(cols = -one_of("Status in t-1"), 
               names_to = "Status in t", 
               values_to = "Frequency") %>%
  ggplot(data = .,
       aes(x=!!as.name("Status in t-1"), 
           y=!!as.name("Status in t"), 
           fill=Frequency)
       ) + 
  geom_tile() +
  geom_text(aes(label = round(Frequency, 2)), color = "white", size = 5) +
  labs(title = "SGP compliance:\nAbsolute changes") + 
  scale_y_discrete(
    labels=c(
      "risk of non-compliance"="risk of non-\ncompliance", 
      "(broadly) compliant"="(broadly) \ncompliant")
    ) +
  scale_fill_viridis_c(option = "D", end = 0.9) +
  theme_bw() + 
  theme(
    axis.ticks = element_blank(), 
    plot.title = element_text(hjust = 0.5),
    axis.text = element_text(size = 12),
    axis.text.x = element_text(angle = 8, hjust = 0.75),
    panel.border = element_blank())

sgp_comp_cond_changes <- cond_results %>%
  as.data.frame() %>%
  rownames_to_column(var = "Status in t-1") %>%
  pivot_longer(cols = -one_of("Status in t-1"), 
               names_to = "Status in t", 
               values_to = "Probability") %>%
  mutate(Probability = 100*Probability) %>%
  ggplot(aes(x=!!as.name("Status in t-1"), 
             y=!!as.name("Status in t"), 
             fill=Probability)) + 
  geom_tile() +
  geom_text(
    aes(label = scales::percent(round(Probability, 2), scale = 1)), 
    color = "white", size = 5) +
  labs(title = "SGP compliance:\nConditional changes") + 
  scale_y_discrete(
    labels=c(
      "risk of non-compliance"="risk of non-\ncompliance", 
      "(broadly) compliant"="(broadly) \ncompliant")
    ) +
  scale_fill_viridis_c(option = "D", end = 0.9) +
  theme_bw() + 
  theme(
    axis.ticks = element_blank(), 
    plot.title = element_text(hjust = 0.5),
    axis.text = element_text(size = 12),
    axis.text.x = element_text(angle = 8, hjust = 0.75),
    panel.border = element_blank())
```

```{r, include=FALSE}
sgp_edp_changes <- ggpubr::ggarrange(
  sgp_abs_changes, sgp_cond_changes,
  sgp_comp_abs_changes, sgp_comp_cond_changes, 
  ncol = 4, labels = paste0(letters[1:4], ")"), 
  common.legend = T, legend = "bottom"
  )
sgp_edp_changes <- ggpubr::annotate_figure(
  sgp_edp_changes, 
  top = ggpubr::text_grob(
    "Absolute and conditional changes for EDP participation and SGP compliance", 
    size = 16))

ggsave(
  filename = here("markdown/figures/sgp_compliance_edp.pdf"), 
  plot = sgp_comp_abs_changes, width = 14, height = 4)
```

```{r sgpTransfers, fig.subcap=subcaps, fig.cap=fig_cap, echo=F, warning=F, out.width='100%', out.height='100%', fig.ncol = 1, eval=FALSE}
fig_cap <- paste0(
  "Number of absolute changes between SGP status (panel a) and conditional ",
  "probability for the status in $t$ given the status in $t-1$ (panel b).",
  "The underlying data refers to all years between 2009 and 2019. ",
  "Panels c and d refer to data between 2014 and 2019 and are concerned ",
  "with the assessment of a country's compliance with the SGP rules."
)

knitr::include_graphics(
  here("markdown/figures/sgp_compliance_edp.pdf"))
```

```{r, include=FALSE}
mip_changes <- ggpubr::ggarrange(
  mip_abs_changes, mip_prob_changes,
  ncol = 2, labels = paste0(letters[1:2], ")")
)

mip_changes <- ggpubr::annotate_figure(
  mip_changes, 
  top = ggpubr::text_grob(
    "Absolute and conditional changes for MIP status (2014-2019)", 
    size = 16))

sgp_changes <- ggpubr::ggarrange(
  sgp_comp_abs_changes + 
    labs(title = "Absolute changes") +
    theme(legend.position = "right"), 
  sgp_comp_cond_changes + 
    labs(title = "Conditional probabilities") +
    theme(legend.position = "right"), 
  nrow = 2, labels = paste0(letters[3:4], ")"), 
  common.legend = F, legend = "right"
)
sgp_changes <- ggpubr::annotate_figure(
  sgp_changes, 
  top = ggpubr::text_grob(
    "SGP compliance (2009-2018)", 
    size = 16))

full_changes <- ggpubr::ggarrange(
  mip_changes, sgp_changes, ncol = 2, widths = c(3,1)
)

mip_sgp_changes_file <- here(
    "markdown/figures/sgp_mip_changes.pdf")
ggsave(
  filename = mip_sgp_changes_file, 
  plot = full_changes, width = 18, height = 5)
```

```{r mipTransfers, fig.subcap=subcaps, fig.cap=fig_cap, echo=F, warning=F, out.width='100%'}
fig_cap <- paste0(
  "Number of absolute changes between MIP status (panel a) and conditional ",
  "probability for the MIP status in $t$ given the status in $t-1$ (panel b), ",
  "as well as the same information for the assessment of a country's ",
  "compliance with the SGP rules.", 
  "The underlying data of panels a and b includes all years between 2012 and ",
  "2019, the data for panels c and spans 2014 and 2019.."
)

knitr::include_graphics(mip_sgp_changes_file)
```


## MIP and SGP Status persistence and development trajectories

So far, all countries have been treated equally. To align the observations with 
the empirical literature on comparative development in Europe and to take into 
account structural path dependencies, an explicit consideration of different 
development paths in the EU seems interesting. To this end, the country groups 
delineated in \citet{Graebner:2020jee} are used.^[The most controversial 
choice here is France: if one considers mainly economic indicators, it is
more of a periphery country, yet, if one focuses on political factors, it is 
more adequate to treat it as part of the core. See \citet{Graebner:2020struc}
for a more extensive discussion of this case.]
\citet{Graebner:2020jee} come up with the classification summarized in table 
\ref{tab:countrygroup} via the means of a descriptive analysis of the 
structural characteristics of the economies as well as a cluster analysis on 
the reaction of countries to a rise of European integration. 
This analysis is consistent with the structuralist view according to which 
countries follow different development trajectories that are 
(a) self-reinforcing and (b) determined not only by the characteristics of the 
individual countries, but also by the relationships between them 
\citep[for more details on this approach see, e.g.,][]{Graebner:2020struc}.
An important determinant of these relationships are the European institutions, 
which, according to \citet{Graebner:2020struc}, foster an 
*intra-European competition*
which then again stabilizes current power asymmetries and unequal development 
patterns \citep[a more detailed discussion can be found in][]{Kapeller:2019cds}.
Based on these results, one would expect more dependent countries to be those 
that are more likely to be trapped in an unfavorable MIP and SGP status, and to 
be more under the surveillance of the EU.

```{=tex}
\begin{table}
\centering
\caption{The country groups delineated by \citet{Graebner:2020jee}.}
\label{tab:countrygroup}
\begin{tabular}{L{0.15\textwidth}L{0.75\textwidth}}
\toprule
\textbf{Country group} & \textbf{Member}\\
\midrule
Core countries        & Austria, Belgium, Denmark, Finland, Germany, Sweden \\
Periphery countries    & Cyprus, France, Greece, Italy, Portugal, Spain      \\
Financial hub         & Ireland, Luxembourg, Malta, Netherlands             \\
Catchup countries     & Bulgaria, Croatia, Czechia, Estonia, Hungary, Latvia, Lithuania, Poland, Romania, Slovakia, Slovenia \\
\bottomrule
\end{tabular}
\end{table}
```

The results on changes in the MIP status that are presented in figure 
\ref{fig:coreperiCondChangesMIP} are largely consistent with this hypothesis, 
and they show a striking difference between periphery countries and the rest. 
The majority of the core countries are in an unproblematic status, yet 
considering the conditional transfers hints at an internal heterogeneity of 
this group also highlighted by \citet{Graebner.2020u}: a core country is either 
consistently located at a situation where it gets regularly diagnosed with 
imbalances by an IDR, or it reaches and remains in a situation where it does 
not receive an IDR at all. Catchup and finance countries are very similar to 
each other, with the former being slightly more persistently located in the 
favorable circumstances. Except the fact that a few of them are not eligible 
for an MIP, they are generally similar to the core countries as well. 
The situation of periphery countries is, however, very different and 
considerably more detrimental: there hardly is any improvement in status and 
persistence in the "worst" categories is strongest compared to the other 
country groups. In the end, not a single periphery country ever leaves the 
problematic status of being either diagnosed with imbalances or not even be 
eligible for the AMR at all.

```{r}
contingency_data_mip_dyn <- contingency_data_sgp %>%
  select(all_of(c("MIP_status", "year", "country_group_jee"))) %>%
  filter(!is.na(MIP_status), !is.na(country_group_jee)) %>%
    mutate(
    MIP_status=ifelse(
      MIP_status=="IDR with no imbalances", "IDR (w/o imb.)", ifelse(
        MIP_status=="IDR with (excessive) imbalances", "IDR (w/ imb.)", ifelse(
          MIP_status=="non eligible for AMR assessment", "Not eligible", 
          as.character(MIP_status)
        )
      )),
    MIP_status=ordered(
      MIP_status, 
      levels=c(
        "No IDR", "IDR (w/o imb.)",
        "IDR (w/ imb.)", "Not eligible")
      ),
    country_group_jee=ordered(
      country_group_jee,
      levels=c(
        "Core", "Catchup", "Finance", "Periphery"
      )
    )
    )
min_year <- min(contingency_data_mip_dyn$year)
max_year <- max(contingency_data_mip_dyn$year)
contingency_data_mip_dyn <- contingency_data_mip_dyn %>%
  group_by(year, country_group_jee) %>%
  count(MIP_status, .drop=F) %>%
  mutate(n_total = sum(n),
         n_rel = n/n_total)

mip_rel_dyn <- ggplot(
  data = contingency_data_mip_dyn, 
  aes(x=year, y=n_rel, fill=MIP_status)
  ) +
  facet_wrap(~country_group_jee, ncol = 4) +
  guides(fill=guide_legend(nrow=1)) +
  scale_y_continuous(
    expand = expansion(), 
    labels = scales::percent_format(scale = 100)
    ) +
  scale_x_continuous(
    expand = expansion(), breaks = c(2013, 2015, 2017)) +
  geom_area() + theme_bw() +
  scale_fill_viridis_d(direction = -1) +
  theme(
    panel.border = element_blank(), axis.ticks = element_blank(),
    axis.title = element_blank(),
    axis.text = element_text(size=12),
    legend.text = element_text(size = 13),
    legend.position = "bottom", legend.title = element_blank(),
    strip.text = element_text(size=14),
    strip.background = element_rect(fill = "white", color="white")
  )
```

```{r}
MIP_country_groups_rel <- macro_data %>%
  filter(year<2020, year>=2012) %>% 
  select(any_of(c("year", "MIP_status", "country_group_jee"))) %>%
  count(MIP_status, year, .drop = FALSE) %>% 
  filter(!is.na(MIP_status), !is.na(year)) %>%
  group_by(year) %>% 
  mutate(year_total=sum(n)) %>% 
  ungroup() %>% 
  mutate(year_rel = n /year_total) %>%
  select(any_of(c("year", "MIP_status", "year_rel"))) %>%
  pivot_wider(names_from = "year", values_from = "year_rel") %>%
  pivot_longer(
    cols = -any_of(c("MIP_status")), 
    names_to = "year", values_to = "year_rel") %>%
  mutate(year_rel=ifelse(is.na(year_rel), 0, year_rel), year=as.double(year)) %>%
  mutate(
    MIP_status=ifelse(
      MIP_status=="IDR with no imbalances", "IDR (w/o imb.)", ifelse(
        MIP_status=="IDR with (excessive) imbalances", "IDR (w/ imb.)", ifelse(
          MIP_status=="non eligible for AMR assessment", "Not eligible", 
          as.character(MIP_status)
        )
      )),
    MIP_status=ordered(
      MIP_status, 
      levels=c(
        "No IDR", "IDR (w/o imb.)",
        "IDR (w/ imb.)", "Not eligible")
      )
    ) %>% 
  ggplot(data = ., mapping = aes(x=year, y=year_rel, fill=MIP_status)) +
  geom_area() + 
  labs(title = "MIP status") +
  scale_x_continuous(
    breaks = seq(2012, 2020, 2),
    expand = expansion()
  ) +
  scale_y_continuous(
    limits = c(0, 1), expand = expansion(), 
    breaks = seq(0,1,0.2),
    labels = scales::percent_format()
  ) +
  scale_fill_viridis_d() +
  guides(fill=guide_legend(nrow=2)) +
  theme_bw() +
  theme(
    legend.position = "bottom", legend.title = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(), panel.border = element_blank()
  )
```

```{r edpContingencyGroupsAbs}
MIP_contingency <- contingency_data_mip %>%
  select(one_of("country_group_jee", "iso3c", "year", "MIP_status")) %>%
  pivot_wider(id_cols = c("country_group_jee", "iso3c"), 
              names_from = "year", values_from = "MIP_status")

years <- 2012:2019
c_groups <- unique(MIP_contingency$country_group_jee)
c_groups <- c_groups[!is.na(c_groups)]
results <- list()
for (g in c_groups){
  c_results <- list()
  MIP_contingency_red <- MIP_contingency %>%
    filter(country_group_jee==g)
  for (y in years){
  con_table <- prop.table(table(
    MIP_contingency_red[[as.character(y)]], 
    MIP_contingency_red[[as.character(y+1)]]), 
    margin = 1)
  c_results[[as.character(y)]] <- con_table
  }
  results[[g]] <- apply(simplify2array(c_results), 1:2, mean, na.rm=T)
}

plot_list <- list()
for (g in c_groups) {
  plot_list[[g]]  <- results[[g]] %>%
    as.data.frame() %>%
    rownames_to_column(var = "Status in t-1") %>%
    pivot_longer(
      cols = -one_of("Status in t-1"),
      names_to = "Status in t",
      values_to = "Probability"
    )  %>%
    ggplot(
      data = .,
      aes(
        x = !!as.name("Status in t-1"),
        y = !!as.name("Status in t"),
        fill = Probability
      )
    ) +
    geom_tile() +
    geom_text(
      aes(label = scales::percent(Probability, scale = 100, accuracy = 2)), 
      color = "white", size = 5) +
    labs(title = paste0(g, " countries")) +
    scale_fill_viridis_c(option = "D", limit=c(0, 1)) +
    theme_bw() +
    theme(
      axis.ticks = element_blank(),
      axis.text.x = element_text(angle = 15, hjust = 0.75, size = 11),
      axis.text.y = element_text(size=12),
      axis.title = element_text(size=13), 
      plot.title = element_text(hjust = 0.5, size = 14),
      panel.border = element_blank()
    )
}
```

```{r, include=FALSE}
core_plot <- plot_list$Core + theme(legend.position = "none")

cond_changes_mip <- ggpubr::ggarrange(
  ggpubr::ggarrange(
  mip_rel_dyn, core_plot, widths = c(2,1),
  ncol = 2, labels = paste0(letters[1:2], ")"), 
  common.legend = F
  ), 
  ggpubr::ggarrange(
  plot_list$Catchup, plot_list$Finance, plot_list$Periphery,
  ncol = 3, labels = paste0(letters[3:5], ")"), 
  common.legend = T, legend = "none"
  ),
  nrow = 2
)

cond_changes_mip_file <- here(
  "markdown/figures/cond_changes_mip.pdf")
  
ggsave(
  filename = cond_changes_mip_file, 
  plot = cond_changes_mip, width = 14, height = 6)
```

```{r coreperiCondChangesMIP, fig.subcap=subcaps, fig.cap=fig_cap, echo=F, warning=F, out.width='100%', fig.ncol = 4}
fig_cap <- 
  "Conditional transfers between MIP status categories for different country groups (2012 - 2019)."
knitr::include_graphics(cond_changes_mip_file)
```

\FloatBarrier

Results on the compliance with the SGP rules are presented in figure 
\ref{fig:coreperiTransfersSGPCond}. Only Euro Area members are considered here 
since only those get evaluated on basis of their DBP. When it comes to the 
shares of the countries in the respective status groups, one again finds 
immediately that while the vast majority of core, catchup and financialized 
countries are considered to behave (broadly) compliant with the SGP rules, 
the situation for periphery countries is exactly the opposite. When it comes 
to the conditional movements, one finds moderate levels of path dependency in 
the case of core countries: compliant countries tend to remain compliant, yet 
nothing like this can be said for non-compliant countries. Catchup countries 
behave pretty persistently either in accordance with or against the SGP rules 
(but with the vast majority of catchup countries complying with the rules), 
whereas periphery countries take an intermediate position: they show 
considerable persistence, yet still to a lesser extent than the catchup 
countries. Financialized countries always are considered compliant.

```{r}
SGP_Comp_contingency <- contingency_data_sgp %>%
  select(one_of("country_group_jee", "iso3c", "year", "SGP_compliance")) %>%
  filter(!is.na(SGP_compliance)) %>%
  pivot_wider(id_cols = c("country_group_jee", "iso3c"), 
              names_from = "year", values_from = "SGP_compliance")

years <- 2014:2018
c_groups <- unique(SGP_Comp_contingency$country_group_jee)
c_groups <- c_groups[!is.na(c_groups)]
results <- list()
for (g in c_groups){
  c_results <- list()
  SGP_contingency_red <- SGP_Comp_contingency %>%
    filter(country_group_jee==g)
  for (y in years){
  con_table <- prop.table(table(
    SGP_contingency_red[[as.character(y)]], 
    SGP_contingency_red[[as.character(y+1)]]), 
    margin = 1)
  c_results[[as.character(y)]] <- con_table
  }
  results[[g]] <- apply(simplify2array(c_results), 1:2, mean, na.rm=T)
}

plot_list_SGP <- list()
for (g in c_groups) {
  plot_list_SGP[[g]]  <- results[[g]] %>%
    as.data.frame() %>%
    rownames_to_column(var = "Status in t-1") %>%
    pivot_longer(
      cols = -one_of("Status in t-1"),
      names_to = "Status in t",
      values_to = "Probability"
    )  %>%
    ggplot(
      data = .,
      aes(
        x = !!as.name("Status in t-1"),
        y = !!as.name("Status in t"),
        fill = Probability
      )
    ) +
    geom_tile() +
    geom_text(
      aes(label = scales::percent(round(Probability, 2), scale = 100)), 
      color = "white", size = 5) +
    scale_y_discrete(labels = c("(broadly)\n compliant", "risk of non-\n compliance")) +
    labs(title = paste0(g, " countries")) +
    scale_fill_viridis_c(option = "D", limit=c(0, 1)) +
    theme_bw() +
    theme(
      axis.ticks = element_blank(),
      axis.text.x = element_text(angle = 15, hjust = 0.75, size = 11),
      axis.text.y = element_text(size=12),
      axis.title = element_text(size=13), 
      plot.title = element_text(hjust = 0.5, size = 14),
      panel.border = element_blank()
    )
}
```

```{r}
contingency_data_sgp_compl_dyn <- contingency_data_sgp %>%
  select(all_of(c("SGP_compliance", "year", "country_group_jee"))) %>%
  filter(!is.na(SGP_compliance), !is.na(country_group_jee)) %>%
    mutate(
    country_group_jee=ordered(
      country_group_jee,
      levels=c(
        "Core", "Catchup", "Finance", "Periphery"
        )
      )
    )
min_year <- min(contingency_data_sgp_compl_dyn$year)
max_year <- max(contingency_data_sgp_compl_dyn$year)
contingency_data_sgp_compl_dyn <- contingency_data_sgp_compl_dyn %>%
  group_by(year, country_group_jee) %>%
  count(SGP_compliance, .drop=F) %>%
  mutate(n_total = sum(n),
         n_rel = n/n_total)

sgp_compl_rel_dyn <- ggplot(
  data = contingency_data_sgp_compl_dyn, 
  aes(x=year, y=n_rel, fill=SGP_compliance)
  ) +
  facet_wrap(~country_group_jee, ncol = 4) +
  guides(fill=guide_legend(nrow=1)) +
  scale_y_continuous(
    expand = expansion(), 
    labels = scales::percent_format(scale = 100)
    ) +
  scale_x_continuous(expand = expansion(), breaks = 2014:2018) +
  geom_area() + theme_bw() +
  scale_fill_viridis_d(direction = -1) +
  theme(
    panel.border = element_blank(), axis.ticks = element_blank(),
    axis.title = element_blank(),
    legend.position = "bottom", legend.title = element_blank(),
      axis.text = element_text(size=12),
    legend.text = element_text(size = 13),
    strip.text = element_text(size=14),
    strip.background = element_rect(fill = "white", color="white")
  )
```

```{r}
core_plot <- plot_list_SGP$Core + theme(legend.position = "none")

cond_changes_sgp_compl <- ggpubr::ggarrange(
  ggpubr::ggarrange(
  sgp_compl_rel_dyn, core_plot, widths = c(2,1),
  ncol = 2, labels = paste0(letters[1:2], ")"), 
  common.legend = F
  ), 
  ggpubr::ggarrange(
  plot_list_SGP$Catchup, plot_list_SGP$Finance, plot_list_SGP$Periphery,
  ncol = 3, labels = paste0(letters[3:5], ")"), 
  common.legend = T, legend = "none"
  ),
  nrow = 2
)

cond_changes_sgp_compl_file <- here(
  "markdown/figures/cond_changes_sgp_compl.pdf")

ggsave(
  filename = cond_changes_sgp_compl_file, 
  plot = cond_changes_sgp_compl, width = 14, height = 6)
```

```{r coreperiTransfersSGPCond, fig.subcap=subcaps, fig.cap=fig_cap, echo=F, warning=F, out.width='100%'}
fig_cap <- 
  "Conditional transfers for different countries regarding their compliance with the SGP (2014-2018)."
knitr::include_graphics(cond_changes_sgp_compl_file)
```

\FloatBarrier

When it comes to the participation in an EDP (see figure 
\ref{fig:coreperiTransfersEDPCond}), one observes, first, that after the 
financial crisis, the majority of countries in all groups entered an EDP. 
In the following years, the vast majority of countries left the EDP, such that 
in 2019 only one periphery country (Spain) undergoes an EDP. 
Against this background it is not surprising that, when one considers the 
conditional transition probabilities, the cases where Member States switched 
from being in no EDP into being in one are quite rare and stem from the fact 
that certain countries entered the EDP not immediately after the crisis (2009) 
but in 2010. Aside from this, a path dependency is again clearly visible, 
although given the overall trend towards leaving the EDP, the transition 
probabilities are less illuminating for the case of the EDP than for the cases 
discussed above.

```{r}
SGP_EDP_contingency <- contingency_data_sgp %>%
  select(one_of("country_group_jee", "iso3c", "year", "SGP_edp")) %>%
  filter(!is.na(SGP_edp)) %>%
  pivot_wider(id_cols = c("country_group_jee", "iso3c"), 
              names_from = "year", values_from = "SGP_edp")

years <- 2009:2018
c_groups <- unique(SGP_EDP_contingency$country_group_jee)
c_groups <- c_groups[!is.na(c_groups)]
results <- list()
for (g in c_groups){
  c_results <- list()
  SGP_contingency_red <- SGP_EDP_contingency %>%
    filter(country_group_jee==g)
  for (y in years){
  con_table <- prop.table(table(
    SGP_contingency_red[[as.character(y)]], 
    SGP_contingency_red[[as.character(y+1)]]), 
    margin = 1)
  c_results[[as.character(y)]] <- con_table
  }
  results[[g]] <- apply(simplify2array(c_results), 1:2, mean, na.rm=T)
}

plot_list_SGP <- list()
for (g in c_groups) {
  plot_list_SGP[[g]]  <- results[[g]] %>%
    as.data.frame() %>%
    rownames_to_column(var = "Status in t-1") %>%
    pivot_longer(
      cols = -one_of("Status in t-1"),
      names_to = "Status in t",
      values_to = "Probability"
    )  %>%
    ggplot(
      data = .,
      aes(
        x = !!as.name("Status in t-1"),
        y = !!as.name("Status in t"),
        fill = Probability
      )
    ) +
    geom_tile() +
    geom_text(
      aes(label = scales::percent(
        Probability, accuracy = 2, scale = 100)), 
          color = "white", size = 4) +
    labs(title = paste0(g, " countries")) +
    scale_fill_viridis_c(option = "D", limit=c(0, 1)) +
    theme_bw() +
    theme(
      axis.ticks = element_blank(),
      axis.text.x = element_text(angle = 15, hjust = 0.75, size = 11),
      axis.text.y = element_text(size=12),
      axis.title = element_text(size=13), 
      plot.title = element_text(hjust = 0.5, size = 14),
      panel.border = element_blank()
    )
}
```

```{r}
contingency_data_sgp_edp_dyn <- contingency_data_sgp %>%
  select(all_of(c("SGP_edp", "year", "country_group_jee"))) %>%
  filter(!is.na(SGP_edp), !is.na(country_group_jee)) %>%
    mutate(
      SGP_edp = ordered(SGP_edp, levels=c("EDP", "No EDP")),
      country_group_jee=ordered(
        country_group_jee,
        levels=c("Core", "Catchup", "Finance", "Periphery")
        )
      )
min_year <- min(contingency_data_sgp_edp_dyn$year)
max_year <- max(contingency_data_sgp_edp_dyn$year)

contingency_data_sgp_edp_dyn <- contingency_data_sgp_edp_dyn %>%
  group_by(year, country_group_jee) %>%
  count(SGP_edp, .drop=F) %>%
  mutate(n_total = sum(n),
         n_rel = n/n_total)

sgp_edp_rel_dyn <- ggplot(
  data = contingency_data_sgp_edp_dyn, 
  aes(x=year, y=n_rel, fill=SGP_edp)
  ) +
  facet_wrap(~country_group_jee, ncol = 4) +
  guides(fill=guide_legend(nrow=1)) +
  scale_y_continuous(
    expand = expansion(), 
    labels = scales::percent_format(scale = 100)
    ) +
  scale_x_continuous(expand = expansion(), 
                     breaks = seq(2010, 2018, 2)
                     )+
  geom_area() + theme_bw() +
  scale_fill_viridis_d(direction = -1) +
  theme(
    panel.border = element_blank(), axis.ticks = element_blank(),
    axis.title = element_blank(),
    legend.position = "bottom", legend.title = element_blank(),
    strip.text = element_text(size=14),
    axis.text = element_text(size=12),
    legend.text = element_text(size = 13),
    strip.background = element_rect(fill = "white", color="white")
  )
```

```{r, include=FALSE}
core_plot <- plot_list_SGP$Core + theme(legend.position = "none")

cond_changes_sgp_edp <- ggpubr::ggarrange(
  ggpubr::ggarrange(
  sgp_edp_rel_dyn, core_plot, widths = c(2,1),
  ncol = 2, labels = paste0(letters[1:2], ")"), 
  common.legend = F
  ), 
  ggpubr::ggarrange(
  plot_list_SGP$Catchup, plot_list_SGP$Finance, plot_list_SGP$Periphery,
  ncol = 3, labels = paste0(letters[3:5], ")"), 
  common.legend = T, legend = "none"
  ),
  nrow = 2
)


cond_changes_sgp_edp_file <- here("markdown/figures/cond_changes_dyn_edp.pdf")
ggsave(
  filename = cond_changes_sgp_edp_file, 
  plot = cond_changes_sgp_edp, width = 14, height = 6)
```

```{r coreperiTransfersEDPCond, fig.subcap=subcaps, fig.cap=fig_cap, echo=F, warning=F, out.width='100%'}
fig_cap <- 
  "Conditional transfers for different country groups regarding their participation in an EDP (2009-2019)."
knitr::include_graphics(cond_changes_sgp_edp_file)
```
\FloatBarrier

## MIP and SGP status transition over whole period

Figures \ref{fig:mipTransfers2} and \ref{fig:sgpTransfers2} show absolute and 
conditional transition
probabilities for the SGP and MIP status *over the whole period*. Here we compare the 
status in $t_{min}$ with that in $t_{max}$.

This consideration corroborates the findings from the main paper and 
indicates that over 80% of the countries that
did not receive an IDR in 2012 remained in this positive area.
From those with imbalances in 2012, the picture is more nuanced, yet also 
compatible with the polarization findings: six of those 12 countries with 
imbalances continued to remain in this unfavorable status. Six of these 
countries actually managed to move to the favorable stats of `No IDR`, yet all
of them belong to the group of core or catch-up countries.^[The countries
are Belgium, Denmark, Finland (all core countries), Hungary, Slovenia 
(catch-up countries) and the United Kingdom.]
Periphery countries remained fully in their unfavorable status:
all of them are classified as `IDR with imbalances` in 2019.



```{r}
load(here::here("output/min_max_tansitions.Rdata"))
```

```{r}
mip_abs_changes <- mip_abs_results_min_max %>%
  data.frame() %>%
  rename(
    `Status in 2012`=Var1, 
    `Status in 2018`=Var2, 
    `Frequency`=`Freq`
    ) %>%
  ggplot(data = .,
       aes(x=!!as.name("Status in 2012"), 
           y=!!as.name("Status in 2018"), 
           fill=Frequency)
       ) + 
  geom_tile() +
  geom_text(aes(label = round(Frequency, 2)), color = "white", size = 5) +
  labs(title = "Absolute changes in MIP status") + 
  scale_fill_viridis_c(
    option = "D", end = 0.9,  breaks = c(0, 3, 6, 9)) +
  theme_bw() + 
  theme(
    axis.ticks = element_blank(), 
    plot.title = element_text(hjust = 0.5),
    axis.text = element_text(size = 12),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    panel.border = element_blank())

mip_cond_changes <- mip_rel_results_min_max %>%
  data.frame() %>%
  rename(
    `Status in 2012`=Var1, 
    `Status in 2018`=Var2, 
    `Cond. prob.`=`Freq`
    ) %>%
  mutate(`Cond. prob` = 100*`Cond. prob.`) %>%
  ggplot(aes(x=!!as.name("Status in 2012"), 
             y=!!as.name("Status in 2018"), 
             fill=`Cond. prob`)) + 
  geom_tile() +
  geom_text(
    aes(label = scales::percent(round(`Cond. prob`, 2), scale = 1)), 
    color = "white", size = 5) +
  labs(title = "Absolute changes in MIP status") + 
  scale_fill_viridis_c(option = "D", end = 0.9) +
  theme_bw() + 
  theme(
    axis.ticks = element_blank(), 
    plot.title = element_text(hjust = 0.5),
    axis.text = element_text(size = 12),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    panel.border = element_blank())
```


```{r}
mip_changes <- ggpubr::ggarrange(
  mip_abs_changes, mip_cond_changes,
  ncol = 2, labels = paste0(letters[1:2], ")")
  )
  
mip_changes <- ggpubr::annotate_figure(
  mip_changes, 
  top = ggpubr::text_grob(
    "Absolute and conditional changes for MIP status (2014 to 2018)", 
    size = 16))

mip_changes_file <- here(
  "markdown/figures/app_mip_changes_minmax.pdf")

ggsave(
  filename = mip_changes_file, 
  plot = mip_changes, width = 14, height = 4)
```

```{r mipTransfers2, fig.subcap='Absolute', fig.cap=fig_cap, echo=F, warning=F, out.width='100%'}
fig_cap <- paste0(
  "Number of absolute changes between MIP status in 2018 compared to 2012 ",
  "(panel a) and conditional probability for the status in 2018 given the ",
  "status in 2012 (panel b). ",
  "The underlying data refers to all years between 2012 and 2019."
)

knitr::include_graphics(mip_changes_file)
```

```{r, echo=F}
sgp_abs_changes <- edp_abs_results_min_max %>%
  data.frame() %>%
  rename(
    `Status in 2009`=Var1, 
    `Status in 2018`=Var2, 
    `Frequency`=`Freq`
    ) %>%
  ggplot(data = .,
       aes(x=!!as.name("Status in 2009"), 
           y=!!as.name("Status in 2018"), 
           fill=Frequency)
       ) + 
  geom_tile() +
  geom_text(aes(label = round(Frequency, 2)), color = "white", size = 5) +
  labs(title = "Participation in EDP:\nAbsolute changes") + 
  scale_fill_viridis_c(option = "D", end = 0.9) +
  theme_bw() + 
  theme(
    axis.ticks = element_blank(), 
    plot.title = element_text(hjust = 0.5),
    axis.text = element_text(size = 12),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    panel.border = element_blank())

sgp_cond_changes <- edp_rel_results_min_max %>%
  data.frame() %>%
  rename(
    `Status in 2009`=Var1, 
    `Status in 2018`=Var2, 
    `Probability`=`Freq`
    ) %>%
  mutate(Probability = 100*Probability) %>%
  ggplot(aes(x=!!as.name("Status in 2009"), 
             y=!!as.name("Status in 2018"), 
             fill=Probability)) + 
  geom_tile() +
  geom_text(
    aes(label = scales::percent(round(Probability, 2), scale = 1)), 
    color = "white", size = 5) +
  labs(title = "Participation in EDP\nConditional changes") + 
  scale_fill_viridis_c(option = "D", end = 0.9) +
  theme_bw() + 
  theme(
    axis.ticks = element_blank(), 
    plot.title = element_text(hjust = 0.5),
    axis.text = element_text(size = 12),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    panel.border = element_blank())
```

```{r, echo=F}
sgp_comp_abs_changes <- sgp_abs_results_min_max %>%
  data.frame() %>%
  rename(
    `Status in 2014`=Var1, 
    `Status in 2018`=Var2, 
    `Frequency`=`Freq`
    ) %>%
  ggplot(data = .,
       aes(x=!!as.name("Status in 2014"), 
           y=!!as.name("Status in 2018"), 
           fill=Frequency)
       ) + 
  geom_tile() +
  geom_text(aes(label = round(Frequency, 2)), color = "white", size = 5) +
  labs(title = "SGP compliance:\nAbsolute changes") + 
  scale_y_discrete(
    labels=c(
      "risk of non-compliance"="risk of non-\ncompliance", 
      "(broadly) compliant"="(broadly) \ncompliant")
    ) +
  scale_fill_viridis_c(option = "D", end = 0.9) +
  theme_bw() + 
  theme(
    axis.ticks = element_blank(), 
    plot.title = element_text(hjust = 0.5),
    axis.text = element_text(size = 12),
    axis.text.x = element_text(angle = 8, hjust = 0.75),
    panel.border = element_blank())

sgp_comp_cond_changes <- sgp_rel_results_min_max %>%
  data.frame() %>%
  rename(
    `Status in 2014`=Var1, 
    `Status in 2018`=Var2, 
    `Probability`=`Freq`
    ) %>%
  mutate(Probability = 100*Probability) %>%
  ggplot(aes(x=!!as.name("Status in 2014"), 
             y=!!as.name("Status in 2018"), 
             fill=Probability)) + 
  geom_tile() +
  geom_text(
    aes(label = scales::percent(round(Probability, 2), scale = 1)), 
    color = "white", size = 5) +
  labs(title = "SGP compliance:\nConditional changes") + 
  scale_y_discrete(
    labels=c(
      "risk of non-compliance"="risk of non-\ncompliance", 
      "(broadly) compliant"="(broadly) \ncompliant")
    ) +
  scale_fill_viridis_c(option = "D", end = 0.9) +
  theme_bw() + 
  theme(
    axis.ticks = element_blank(), 
    plot.title = element_text(hjust = 0.5),
    axis.text = element_text(size = 12),
    axis.text.x = element_text(angle = 8, hjust = 0.75),
    panel.border = element_blank())
```

```{r, include=FALSE}
sgp_comp_abs_changes <- ggpubr::ggarrange(
  sgp_abs_changes, sgp_cond_changes,
  sgp_comp_abs_changes, sgp_comp_cond_changes, 
  ncol = 4, labels = paste0(letters[1:4], ")"), 
  common.legend = T, legend = "bottom"
  )
sgp_comp_abs_changes <- ggpubr::annotate_figure(
  sgp_comp_abs_changes, 
  top = ggpubr::text_grob(
    "Absolute and conditional changes for EDP participation and SGP compliance", 
    size = 16))

ggsave(
  filename = here(
    "markdown/figures/app_sgp_compliance_edp_minmax.pdf"), 
  plot = sgp_comp_abs_changes, width = 14, height = 4)
```

```{r sgpTransfers2, fig.subcap='Absolute', fig.cap=fig_cap, echo=F, warning=F, out.width='100%', out.height='100%', fig.ncol = 1}
fig_cap <- paste0(
  "Number of absolute changes between SGP status (panel a) and conditional ",
  "probability for the status in 2018 given the status in 2014 (panel b).",
  "Panels c and d refer to data from 2009 and 2018 and are concerned ",
  "with the assessment of a country's compliance with the SGP rules."
)

knitr::include_graphics(
  here("markdown/figures/app_sgp_compliance_edp_minmax.pdf"))
```

```{r, eval=FALSE}
# Countries that are in an IDR with imb in 2012 and are in no IDR in 2019:
MIP_contingency %>% 
  filter(`2012`=="IDR (w/ imb.)", `2019`=="No IDR") %>%
  pull(var = "iso3c") %>%
  countrycode::countrycode(., "iso3c", "country.name")  %>%
  sort(.)
```

```{r, eval=FALSE}
# Countries that are in an IDR with imb in 2012 and are in no IDR in 2019:
MIP_contingency %>% 
  filter(`2012`=="IDR (w/ imb.)", `2019`=="IDR (w/ imb.)") %>%
  pull(var = "iso3c") %>%
  countrycode::countrycode(., "iso3c", "country.name")  %>%
  sort(.)
```

```{r, eval=FALSE}
# Other unfavorable status:
MIP_contingency %>% 
  filter(`2019`=="IDR (w/ imb.)") %>%
  pull(var = "iso3c") %>%
  countrycode::countrycode(., "iso3c", "country.name")  %>%
  sort(.)
```




# MIP indicators for countries with different MIP or SGP classification and no classification {#sec:pics}

```{r dataSetupCountryChar}
country_char_data <- macro_data %>%
  select(any_of(c(
    "year", "iso3c", "country_group_jee",
    "SGP_edp", "MIP_status", "REER_42tp_change3y", 
    "export_shares_change5y", "ulc_ch3y"))
    ) %>%
  mutate(across(where(is.numeric), as.double))%>% 
  mutate(countryname = countrycode::countrycode(iso3c, "iso3c", "country.name"))
```

```{r MakeMipCompetitiveness}
update_theme <- function(x){
  x +
    theme_bw() +
    theme(
      panel.border = element_blank(), 
      plot.title = element_text(hjust = 0.5, size = 16),
      strip.background = element_rect(color="white", fill="white"),
      axis.line = element_line(), legend.position = "bottom",
      axis.title.y = element_text(size = 14),
      axis.text = element_text(size = 14), 
      legend.text = element_text(size = 15),
      axis.title.x = element_blank(), legend.title = element_blank()
      )
}

mip_comp_plot_data <- country_char_data %>%
  select(-all_of(c("iso3c", "country_group_jee", "SGP_edp"))) %>%
  filter(!is.na(MIP_status)) %>%
  mutate(
    MIP_status=ifelse(
      MIP_status=="IDR with no imbalances", "IDR (w/o imb.)", ifelse(
        MIP_status=="IDR with (excessive) imbalances", "IDR (w/ imb.)", ifelse(
          MIP_status=="non eligible for AMR assessment", "Not eligible", 
          as.character(MIP_status)
        )
      )),
    MIP_status=ordered(
      MIP_status, 
      levels=c(
        "No IDR", "IDR (w/o imb.)",
        "IDR (w/ imb.)", "Not eligible")
      )
    ) %>%
  group_by(year, MIP_status, .drop="all") %>%
  summarise(
    across(where(is.numeric), ~mean(.x, na.rm = TRUE), .names = "{.col}_mean"),
    across(where(is.numeric), ~sd(.x, na.rm = TRUE), .names = "{.col}_sd"),
    .groups = "drop"
  )

mip_comp_plot_reer <- mip_comp_plot_data %>%
  filter(!is.na(REER_42tp_change3y_mean)) %>%
  mutate(
    lower = REER_42tp_change3y_mean - 0.5*REER_42tp_change3y_sd,
    upper = REER_42tp_change3y_mean + 0.5*REER_42tp_change3y_sd
  ) %>%
  ggplot(data = ., 
         mapping = aes(x=year, y=REER_42tp_change3y_mean, color=MIP_status)
         ) +
  geom_line(key_glyph=draw_key_rect) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  geom_hline(yintercept = 5) +
  geom_hline(yintercept = -5) +
  geom_hline(yintercept = -11, linetype="dashed") +
  geom_hline(yintercept = 11, linetype="dashed") +
  geom_line(aes(y=lower), linetype="dashed", alpha=0.5) + 
  geom_line(aes(y=upper), linetype="dashed", alpha=0.5) + 
  labs(
    title = "Real effective exchange rate",
    y = "Avg. 3-year changes"
  ) 
mip_comp_plot_reer <- update_theme(mip_comp_plot_reer)

mip_comp_plot_ulc <- mip_comp_plot_data %>%
  filter(!is.na(ulc_ch3y_mean)) %>%
  mutate(
    lower = ulc_ch3y_mean - 0.5*ulc_ch3y_sd,
    upper = ulc_ch3y_mean + 0.5*ulc_ch3y_sd
  ) %>%
  ggplot(data = ., 
         mapping = aes(x=year, y=ulc_ch3y_mean, color=MIP_status)
         ) +
  geom_line(key_glyph=draw_key_rect) + 
  geom_hline(yintercept = 9) +
  geom_hline(yintercept = 12, linetype="dashed") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  geom_line(aes(y=lower), linetype="dashed", alpha=0.5) + 
  geom_line(aes(y=upper), linetype="dashed", alpha=0.5) + 
  labs(
    title = "Unit labor costs",
    y = "Avg. 3-year changes"
  ) 
mip_comp_plot_ulc <- update_theme(mip_comp_plot_ulc)

mip_comp_plot_exp <- mip_comp_plot_data %>%
  filter(!is.na(export_shares_change5y_mean)) %>%
  mutate(
    lower = export_shares_change5y_mean - 0.5*export_shares_change5y_sd,
    upper = export_shares_change5y_mean + 0.5*export_shares_change5y_sd
  ) %>%
  ggplot(data = ., 
         mapping = aes(x=year, y=export_shares_change5y_mean, color=MIP_status)
         ) +
  geom_line(key_glyph=draw_key_rect) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  geom_hline(yintercept = -6) +
  geom_line(aes(y=lower), linetype="dashed", alpha=0.5) + 
  geom_line(aes(y=upper), linetype="dashed", alpha=0.5) + 
  labs(
    title = "World export shares",
    y = "Avg. 5-year changes"
  ) 
mip_comp_plot_exp <- update_theme(mip_comp_plot_exp)

mip_comp_plot_full <- ggpubr::ggarrange(
  mip_comp_plot_reer, mip_comp_plot_ulc, 
  mip_comp_plot_exp, ncol = 3, labels = paste0(letters[1:3], ")"), 
  common.legend = T, legend = "bottom"
)

ggsave(
  filename = here("markdown/figures/mipCompetitiveness.pdf"),
  plot = mip_comp_plot_full, width = 14, height = 4)
```

```{r MakeSGPCompetitiveness}
sgp_comp_plot_data <- country_char_data %>%
  select(-all_of(c("iso3c", "country_group_jee", "MIP_status"))) %>%
  filter(!is.na(SGP_edp)) %>%
  group_by(year, SGP_edp, .drop="all") %>%
  summarise(
    across(where(is.numeric), ~mean(.x, na.rm = TRUE), .names = "{.col}_mean"),
    across(where(is.numeric), ~sd(.x, na.rm = TRUE), .names = "{.col}_sd"),
    .groups = "drop"
  )

mip_comp_plot_reer <- sgp_comp_plot_data %>%
  filter(!is.na(REER_42tp_change3y_mean)) %>%
  mutate(
    lower = REER_42tp_change3y_mean - 0.5*REER_42tp_change3y_sd,
    upper = REER_42tp_change3y_mean + 0.5*REER_42tp_change3y_sd
  ) %>%
  ggplot(data = ., 
         mapping = aes(x=year, y=REER_42tp_change3y_mean, color=SGP_edp)
         ) +
  geom_line(key_glyph=draw_key_rect) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_color_viridis_d() +
  geom_hline(yintercept = 5) +
  geom_hline(yintercept = -5) +
  geom_hline(yintercept = -11, linetype="dashed") +
  geom_hline(yintercept = 11, linetype="dashed") +
  geom_line(aes(y=lower), linetype="dashed", alpha=0.5) + 
  geom_line(aes(y=upper), linetype="dashed", alpha=0.5) + 
  labs(
    title = "Real effective exchange rate",
    y = "Avg. 3-year changes"
  ) 
mip_comp_plot_reer <- update_theme(mip_comp_plot_reer)

mip_comp_plot_ulc <- sgp_comp_plot_data %>%
  filter(!is.na(ulc_ch3y_mean)) %>%
  mutate(
    lower = ulc_ch3y_mean - 0.5*ulc_ch3y_sd,
    upper = ulc_ch3y_mean + 0.5*ulc_ch3y_sd
  ) %>%
  ggplot(data = ., 
         mapping = aes(x=year, y=ulc_ch3y_mean, color=SGP_edp)
         ) +
  geom_line(key_glyph=draw_key_rect) + 
  geom_hline(yintercept = 9) +
  geom_hline(yintercept = 12, linetype="dashed") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_color_viridis_d() +
  geom_line(aes(y=lower), linetype="dashed", alpha=0.5) + 
  geom_line(aes(y=upper), linetype="dashed", alpha=0.5) + 
  labs(
    title = "Unit labor costs",
    y = "Avg. 3-year changes"
  ) 
mip_comp_plot_ulc <- update_theme(mip_comp_plot_ulc)

mip_comp_plot_exp <- sgp_comp_plot_data %>%
  filter(!is.na(export_shares_change5y_mean)) %>%
  mutate(
    lower = export_shares_change5y_mean - 0.5*export_shares_change5y_sd,
    upper = export_shares_change5y_mean + 0.5*export_shares_change5y_sd
  ) %>%
  ggplot(data = ., 
         mapping = aes(x=year, y=export_shares_change5y_mean, color=SGP_edp)
         ) +
  geom_line(key_glyph=draw_key_rect) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_color_viridis_d() +
  geom_hline(yintercept = -6) +
  geom_line(aes(y=lower), linetype="dashed", alpha=0.5) + 
  geom_line(aes(y=upper), linetype="dashed", alpha=0.5) + 
  labs(
    title = "World export shares",
    y = "Avg. 5-year changes"
  ) 
mip_comp_plot_exp <- update_theme(mip_comp_plot_exp)

mip_comp_plot_full <- ggpubr::ggarrange(
  mip_comp_plot_reer, mip_comp_plot_ulc, 
  mip_comp_plot_exp, ncol = 3, labels = paste0(letters[1:3], ")"), 
  common.legend = T, legend = "bottom"
)

ggsave(
  filename = here("markdown/figures/sgpCompetitiveness.pdf"),
  plot = mip_comp_plot_full, width = 14, height = 4)
```


```{r mipCompetitiveness, fig.subcap=subcaps, fig.cap=fig_cap, echo=F, warning=F, out.width='100%'}
fig_cap <- paste0(
  "The three main competitiveness indicators of the MIP for countries in the ",
  "different MIP categories. The complete line refers to the average, the ",
  "dashed lines indicate the standard deviation of the group. The black line ",
  "refers to the threshold of the MIP. If there is an alternative threshold ",
  "for non-Euro countries, it is indicated via a dashed black line."
)
  
knitr::include_graphics(
  here("markdown/figures/mipCompetitiveness.pdf"))
```

```{r sgpCompetitiveness, fig.subcap=subcaps, fig.cap=fig_cap, echo=F, warning=F, out.width='100%'}
fig_cap <- paste0(
  "The three main competitiveness indicators of the MIP for countries that ",
  "undergo an EDP and the rest. The complete line refers to the average, the ",
  "dashed lines indicate the standard deviation of the group. The black line ",
  "refers to the threshold of the MIP. If there is an alternative threshold ",
  "for non-Euro countries, it is indicated via a dashed black line."
)
  
knitr::include_graphics(
  here("markdown/figures/sgpCompetitiveness.pdf"))
```


```{r MakecountryCompetitiveness}
update_theme <- function(x){
  x +
    theme_bw() +
    theme(
      panel.border = element_blank(), 
      plot.title = element_text(hjust = 0.5, size = 16),
      strip.background = element_rect(color="white", fill="white"),
      axis.line = element_line(), legend.position = "bottom",
      axis.title.y = element_text(size = 14),
      axis.text = element_text(size = 14), 
      legend.text = element_text(size = 15),
      axis.title.x = element_blank(), legend.title = element_blank()
      )
}

sgp_comp_plot_data <- country_char_data %>%
  select(-all_of(c( "SGP_edp", "MIP_status"))) %>%
  filter(!is.na(country_group_jee)) %>%
  group_by(year, countryname, .drop="all") %>%
  summarise(
    across(where(is.numeric), ~mean(.x, na.rm = TRUE), .names = "{.col}_mean"),
    across(where(is.numeric), ~sd(.x, na.rm = TRUE), .names = "{.col}_sd"),
    .groups = "drop"
  )

mip_comp_plot_reer <- sgp_comp_plot_data %>%
  filter(!is.na(REER_42tp_change3y_mean)) %>%
  mutate(
    lower = REER_42tp_change3y_mean - 0.5*REER_42tp_change3y_sd,
    upper = REER_42tp_change3y_mean + 0.5*REER_42tp_change3y_sd
  ) %>%
  ggplot(data = ., 
         mapping = aes(x=year, y=REER_42tp_change3y_mean, color=countryname)
         ) +
  geom_line(key_glyph=draw_key_rect) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_color_viridis_d() +
  geom_hline(yintercept = 5) +
  geom_hline(yintercept = -5) +
  geom_hline(yintercept = -11, linetype="dashed") +
  geom_hline(yintercept = 11, linetype="dashed") +
  geom_line(aes(y=lower), linetype="dashed", alpha=0.5) + 
  geom_line(aes(y=upper), linetype="dashed", alpha=0.5) + 
  labs(
    title = "Real effective exchange rate",
    y = "Avg. 3-year changes"
  ) 
mip_comp_plot_reer <- update_theme(mip_comp_plot_reer)

mip_comp_plot_ulc <- sgp_comp_plot_data %>%
  filter(!is.na(ulc_ch3y_mean)) %>%
  mutate(
    lower = ulc_ch3y_mean - 0.5*ulc_ch3y_sd,
    upper = ulc_ch3y_mean + 0.5*ulc_ch3y_sd
  ) %>%
  ggplot(data = ., 
         mapping = aes(x=year, y=ulc_ch3y_mean, color=countryname)
         ) +
  geom_line(key_glyph=draw_key_rect) + 
  geom_hline(yintercept = 9) +
  geom_hline(yintercept = 12, linetype="dashed") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_color_viridis_d() +
  geom_line(aes(y=lower), linetype="dashed", alpha=0.5) + 
  geom_line(aes(y=upper), linetype="dashed", alpha=0.5) + 
  labs(
    title = "Unit labor costs",
    y = "Avg. 3-year changes"
  ) 
mip_comp_plot_ulc <- update_theme(mip_comp_plot_ulc)

mip_comp_plot_exp <- sgp_comp_plot_data %>%
  filter(!is.na(export_shares_change5y_mean)) %>%
  mutate(
    lower = export_shares_change5y_mean - 0.5*export_shares_change5y_sd,
    upper = export_shares_change5y_mean + 0.5*export_shares_change5y_sd
  ) %>%
  ggplot(data = ., 
         mapping = aes(x=year, y=export_shares_change5y_mean, color=countryname)
         ) +
  geom_line(key_glyph=draw_key_rect) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_color_viridis_d() +
  geom_hline(yintercept = -6) +
  geom_line(aes(y=lower), linetype="dashed", alpha=0.5) + 
  geom_line(aes(y=upper), linetype="dashed", alpha=0.5) + 
  labs(
    title = "World export shares",
    y = "Avg. 5-year changes"
  ) 
mip_comp_plot_exp <- update_theme(mip_comp_plot_exp)

mip_comp_plot_full <- ggpubr::ggarrange(
  mip_comp_plot_reer, mip_comp_plot_ulc, 
  mip_comp_plot_exp, ncol = 3, labels = paste0(letters[1:10], ")"), 
  common.legend = T, legend = "bottom"
)

ggsave(
  filename = here("markdown/figures/countryCompetitiveness.pdf"),
  plot = mip_comp_plot_full, width = 14, height = 6)
```

```{r countryCompetitiveness, fig.subcap=subcaps, fig.cap=fig_cap, echo=F, warning=F, out.width='100%'}
fig_cap <- paste0(
  "The three main competitiveness indicators of the MIP for different countries.",
  "The complete line refers to the average, the ",
  "dashed lines indicate the standard deviation. The black line ",
  "refers to the threshold of the MIP. If there is an alternative threshold ",
  "for non-Euro countries, it is indicated via a dashed black line."
)
  
knitr::include_graphics(
  here("markdown/figures/countryCompetitiveness.pdf"))
```

\FloatBarrier

# Details about the implementation scores {#sec:is}

One important element of the European Semester are the CSRs.
The extent to which countries adhere to their 
specific recommendations gets 
assessed by the European Commission using the so called *implementation scores*.
The evaluation is conducted internally, and the progress countries make with
implementing their CSRs is classified as (1) *no*, (2) *limited*, (3) *some*, 
(4) *substantial* or (5) *full* progress.
To quantify this qualitative assessment into the final implementation scores,
each label is given a numerical value, i.e. 0 (for no progress), 0.25, 0.5, 0.75, 
and 1 (for full progress). 
Since 2013 the often rather long and complex CSRs are broken down into sub-parts 
that are evaluated separately. 
The scores as such are not used as
direct measures for the compliance of the countries with their respective 
CSRs. Nevertheless, considering the implementation scores might be useful to
better understand how national efforts are perceived by the Commission.
To this end, more details about the implementation scores are provided below.


Therefore, the following presentation of the implementation scores has to be
interpreted with care. More precisely, they will not be considered as measures
of effectiveness of the European Semester, but rather as indication of 
how vigilant the Commission acts on Member States exhibiting low implementation 
scores. 

Figure \ref{fig:ImplementionScoresGeneral} represents this composition of
CSRs as well as their implementation scores.
The shares and scores are computed for each year from 2011 to 2019 and then 
averaged over the whole time period. 
It shows that while the different policy areas receive very different 
attention in the CSRs (see the discussion in the main text), there is no clear 
relationship between the share of a policy area in CSRs and perceived compliance.

```{r}
policy_area_share <- csr_data %>% 
   filter(!is.na(firstPA), firstPA != "") %>% 
   group_by(firstPA) %>%
  summarise(across("sharePA_all",  ~ mean(.x, na.rm = TRUE)), 
            .groups="drop") %>% 
  mutate(firstPA = fct_reorder(firstPA, sharePA_all)) 

policy_area_score <- csr_data %>% 
  filter(!is.na(firstPA), firstPA != "") %>% 
   group_by(firstPA) %>%
  summarise(across("year_area_AAS",  ~ mean(.x, na.rm = TRUE)), 
            .groups="drop") %>% 
  mutate(firstPA = fct_reorder(firstPA, year_area_AAS))

policy_area_full <- full_join(
  policy_area_share, policy_area_score, by=c("firstPA"))
  
policy_implementation_plot <- ggplot(
  policy_area_full,
  aes(x=firstPA,
      y=sharePA_all)
  ) +
  geom_segment(
    aes(x=firstPA, xend=firstPA, y=0, yend=sharePA_all),
    color="darkgoldenrod2") +
  geom_point(color="#0000b3", size=2) +
  geom_line(
    mapping = aes(x=firstPA, y=year_area_AAS),
    color="red") + 
  geom_point(
    mapping = aes(x=firstPA, y=year_area_AAS),
    color="red") + 
  coord_flip() +
  scale_y_continuous(
    name = "Share of all CSRs (blue dots)", 
    labels = scales::percent_format(scale = 100, accuracy = 1),
    expand = expansion(c(0, 0.1)), 
    sec.axis = sec_axis(
      trans = ~ ., 
      labels = scales::percent_format(scale = 100, accuracy = 1),
      name = "Average implementation score (red dots)")
    ) +
  labs(
    title = "Share of policy area specific CSRs in all CSRs"
  ) +
  theme_bw() +
  theme(
    plot.title = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank(),
    axis.ticks = element_blank(),
    axis.line = element_line(),
    axis.title.y = element_blank(),
    axis.text.x = element_text(angle = 0, vjust = 1, hjust = 0.5), 
    legend.position = "bottom"
  )
```



```{r, echo=F}
policy_implementation_plot <- ggpubr::annotate_figure(
  policy_implementation_plot, top = ggpubr::text_grob(
    "Share of policy area specific CSRs and their implementation", size = 16
  )
)

ggsave(
  filename = here("markdown/figures/imp_score_fig.pdf"), 
  plot = policy_implementation_plot, width = 8, height = 7)
```

```{r ImplementionScoresGeneral, fig.subcap=subcaps, fig.cap=fig_cap, echo=F, warning=F, out.width = '100%', out.height='75%'}
fig_cap <- paste0(
    "The share of policy area specific CSRs in the overall number of recommendations 
    (panel a) ",
    "and average implemenation scores for policy areas averaged over 2011 to 2019 
    (panel b)."
)
subcaps <- c('Absolute')
knitr::include_graphics(
  here("markdown/figures/imp_score_fig.pdf"))
```

Figure \ref{fig:impscores}a shows implementation scores per MIP status, calculated as 
averages per group for the years 2011-2019. 
Scores are generally decreasing, as discussed in the literature
on the effectiveness of the MIP 
\citep{bruegel:2019,bruegel:2018, bruegel:2015, DerooseGriesse:2014, Hradisky:2017, Hradisky:2016}. 
The compliance of countries
with (excessive) imbalances is, according to Commission opinion, highest.
This is in stark contrast to the argument of \citet{bruegel:2019}, according
to whom one reason for the overall decrease of implementation scores lies
in the poor compliance of countries with excessive imbalances.

```{r MIP}
MIP_imp_time <- csr_data %>% 
  filter(!is.na(firstPA), !is.na(MIP_status), firstPA != "") %>% 
  select(all_of(c("year", "MIP_status", "country_year_AAS", "SGP_edp", "SGP_compliance"))) %>% 
  mutate(
    MIP_status=recode(
      MIP_status, 
      "NA"="NA",
      "no IDR"= "no IDR",
      "Non eligible for AMR assessment"="non eligible for AMR assessment",
      "IDR with imbalances"="IDR with (excessive) imbalances",
      "IDR with excessive imbalances"="IDR with (excessive) imbalances",
      "IDR with imbalances and specific monitoring"="IDR with (excessive) imbalances"),
    SGP_edp=recode(
      SGP_edp, 
      "NA"="NA",
      "y1"= "EDP",
      "y2"="EDP",
      "n"="No EDP"),
    SGP_compliance=recode(
      SGP_compliance,
      "compliant"="(broadly) compliant",
      "broadly compliant"="(broadly) compliant",
      "risk of non-compliance"="(particularly serious) risk of non-compliance",
      "particularly serious risk of non-compliance"=
        "(particularly serious) risk of non-compliance",
      "particularly serious non-compliance"="(particularly serious) risk of non-compliance"),
    SGP_compliance=na_if(
      SGP_compliance, "no DBP submitted yet")
    ) %>%
  mutate(
    MIP_status=ifelse(
      MIP_status=="IDR with no imbalances", "IDR (w/o imb.)", ifelse(
        MIP_status=="IDR with (excessive) imbalances", "IDR (w/ imb.)", ifelse(
          MIP_status=="non eligible for AMR assessment", "Not eligible", 
          as.character(MIP_status)
        )
      )),
    MIP_status=ordered(
      MIP_status, 
      levels=c(
        "no IDR", "IDR (w/o imb.)",
        "IDR (w/ imb.)", "Not eligible")
      )
    ) %>%
  group_by(year, MIP_status) %>%
  summarise(across("country_year_AAS",  ~ mean(.x, na.rm = TRUE)), 
            .groups="drop") %>% 
  ggplot(.,
         aes(x=year, y=country_year_AAS, color=MIP_status)
          ) +
  geom_line(key_glyph=draw_key_rect) + 
  geom_point() +
  scale_y_continuous(
    limits = c(0, 1), breaks = seq(0, 1, 0.2), 
    labels = scales::percent_format(scale = 100), expand = expansion()
  ) + 
  scale_x_continuous(
    breaks = seq(2012, 2018, 2)
  ) +
  scale_color_viridis_d() +
  labs(
    title = "Implemenation Scores per MIP status",
    y= "Implementation Score"
    ) +
  theme_bw() +
  theme(
    legend.position="bottom",
    legend.title = element_blank(),
    panel.border = element_blank(),
    axis.line = element_line(),
    axis.title.x = element_blank(),
    plot.title = element_text(hjust = 0.5),
    strip.background = element_rect(color="white", fill="white"))
```

```{r SGP}
SGP_imp_time <- csr_data %>%
  filter(!is.na(firstPA), !is.na(SGP_edp), firstPA != "") %>% 
  select(all_of(c("year", "MIP_status", "country_year_AAS", "SGP_edp", "SGP_compliance"))) %>% 
  mutate(
    MIP_status=recode(
      MIP_status, 
      "NA"="NA",
      "no IDR"= "no IDR",
      "Non eligible for AMR assessment"="non eligible for AMR assessment",
      "IDR with imbalances"="IDR with (excessive) imbalances",
      "IDR with excessive imbalances"="IDR with (excessive) imbalances",
      "IDR with imbalances and specific monitoring"="IDR with (excessive) imbalances"),
    SGP_edp=recode(
      SGP_edp, 
      "NA"="NA",
      "y1"= "EDP",
      "y2"="EDP",
      "n"="No EDP"),
    SGP_compliance=recode(
      SGP_compliance,
      "compliant"="(broadly) compliant",
      "broadly compliant"="(broadly) compliant",
      "risk of non-compliance"="(particularly serious) risk of non-compliance",
      "particularly serious risk of non-compliance"=
        "(particularly serious) risk of non-compliance",
      "particularly serious non-compliance"="(particularly serious) risk of non-compliance"),
    SGP_compliance=na_if(
      SGP_compliance, "no DBP submitted yet")
    ) %>% 
  group_by(year, SGP_edp) %>%
  summarise(across("country_year_AAS",  ~ mean(.x, na.rm = TRUE)), 
            .groups="drop") %>% 
  ggplot(.,
         aes(x=year,
             y=country_year_AAS,
             color=SGP_edp)
          ) +
  geom_line(key_glyph=draw_key_rect) + 
  geom_point() +
  scale_y_continuous(
    limits = c(0, 1), breaks = seq(0, 1, 0.2), 
    labels = scales::percent_format(scale = 100), expand = expansion()
  ) + 
  scale_x_continuous(
    breaks = seq(2012, 2018, 2)
  ) +
  scale_color_viridis_d() +
   labs(
     title = "Implemenation Scores per SGP status",
     y= "Implementation Score"
     ) + 
  theme_bw() +
  theme(
    legend.position="bottom",
    legend.title = element_blank(),
    panel.border = element_blank(),
    axis.line = element_line(),
    axis.title.x = element_blank(),
    plot.title = element_text(hjust = 0.5),
    strip.background = element_rect(color="white", fill="white"))
```

```{r JEEimp}
JEE_imp_time <- csr_data %>% 
  filter(!is.na(firstPA), !is.na(country_group_jee)) %>% 
  group_by(year, country_group_jee) %>%
  summarise(across("country_year_AAS",  ~ mean(.x, na.rm = TRUE)), 
            .groups="drop") %>% 
  ggplot(.,
         aes(x=year,
             y=country_year_AAS,
             color=country_group_jee)
          ) +
  geom_line(key_glyph=draw_key_rect) + 
  geom_point() +
  scale_y_continuous(
    limits = c(0, 1), breaks = seq(0, 1, 0.2), 
    labels = scales::percent_format(scale = 100), expand = expansion()
  ) + 
  scale_x_continuous(
    breaks = seq(2012, 2018, 2)
  ) +
  scale_color_viridis_d() +
  labs(
    title = "Implemenation Scores per country group",
    y= "Implementation Score"
    ) +
  scale_color_viridis_d() +
  theme_bw() +
  theme(
    legend.position="bottom",
    legend.title = element_blank(),
    panel.border = element_blank(),
    axis.line = element_line(),
    axis.title.x = element_blank(),
    plot.title = element_text(hjust = 0.5),
    strip.background = element_rect(color="white", fill="white"))
```

```{r, echo=F}
implementation_figure <- ggpubr::ggarrange(
  MIP_imp_time, SGP_imp_time, JEE_imp_time,
  ncol = 3, labels = paste0(letters[1:3], ")"), 
  common.legend = F, legend = "bottom")

implementation_figure_file <-  here("markdown/figures/AP_implementation_figure.pdf")
ggsave(
  filename = implementation_figure_file, 
  plot = implementation_figure, width = 12, height = 4)
```

```{r impscores, fig.subcap=subcaps, fig.cap=fig_cap, echo=F, warning=F, out.width = '100%', out.height='75%'}
fig_cap <- paste0(
    "Implementation scores according to MIP status (panel a), ",
    "SGP status (panel b), and structural development trajectories (panel c). ",
    "All data covers the period from 2011 to 2019."
)
subcaps <- c('Absolute')
knitr::include_graphics(implementation_figure_file)
```

Results regarding the SGP status are presented in Figure \ref{fig:impscores}b. The 
trend in implementation scores is the same as in the MIP categories as well as 
the overall trend with falling implementation scores. Usually, implementation of
countries being in an EDP was evaluated slightly better than the implementation 
of countries not in an EDP. This, however, changed in the last couple of years.

Figure \ref{fig:impscores}c shows the same statistics for country groups according to the 
taxonomy of \citet{Graebner:2020jee} used in the main text. 
According to Commission opinion periphery countries seem to do slightly
better in implementing than the other groups. 
